# AnDaoWallet H5 系统需求规格说明书（SRS）

## 文档信息

- **项目**：AnDaoWallet HTML5（`@andaowallet/h5`）
- **文档类型**：系统需求规格说明书（Software Requirements Specification, SRS）
- **版本**：v0.1（草案）
- **状态**：编写中
- **最后更新**：2026-01-14

## 变更记录

- v0.1 (2026-01-14)：创建文档骨架
- v0.2 (2026-01-14)：吸收系统概述的需求级内容；调整文档引用为“概要设计/详细设计”

## 目录

1. [引言](#1-引言)
2. [总体描述](#2-总体描述)
3. [角色与使用场景](#3-角色与使用场景)
4. [功能需求](#4-功能需求)
5. [数据与存储需求](#5-数据与存储需求)
6. [外部接口需求](#6-外部接口需求)
7. [非功能性需求](#7-非功能性需求)
8. [错误处理与可观测性需求](#8-错误处理与可观测性需求)
9. [安全与合规需求](#9-安全与合规需求)
10. [验收标准与测试大纲](#10-验收标准与测试大纲)
11. [需求追踪矩阵（对齐检查清单）](#11-需求追踪矩阵对齐检查清单)

---

## 1. 引言

### 1.1 目的

本文档定义 AnDaoWallet H5 的需求边界与验收标准，作为**设计、开发、测试与交付**的统一依据。  
当设计文档（系统概述/详细设计）或实现与本 SRS 冲突时，以本 SRS 的需求与验收条目为准（除非在变更记录中明确更新）。

### 1.2 范围

- 产品形态：PWA / Web（无自建后端）
- 核心能力：基于 ERC-4337（Kernel）的智能合约钱包
- 核心体验：三路径账户创建（A/B/C）、资产管理、交易发送、DApp Provider 集成
- 关键约束：仅依赖外部 RPC / Bundler / Paymaster；敏感数据本地加密存储

### 1.3 术语与缩略语

- **AA**：Account Abstraction（账户抽象）
- **EOA**：Externally Owned Account（外部账户）
- **SCA/Smart Account**：智能合约账户（Kernel）
- **UserOperation / userOp**：ERC-4337 用户操作
- **EntryPoint**：ERC-4337 核心合约
- **Bundler**：负责打包 userOp 并提交链上的服务
- **Paymaster**：Gas 代付组件

### 1.4 参考文档

- `docs/系统概要设计说明书.md`（概要设计：做什么）
- `docs/系统详细设计.md`（详细设计：怎么做）
- `docs/API接口文档.md`
- `docs/check_list.md`

---

## 2. 总体描述

### 2.1 产品定位

AnDaoWallet H5 是一个**完全无服务端、纯前端**的智能合约钱包（Kernel / ERC-4337）。用户资产在链上智能合约账户中，H5 提供账户管理、交易、签名与 DApp 连接能力。

### 2.1.1 业务背景（NFT 盲盒投票）

本钱包的目标用户来自一个 **NFT 盲盒产品**生态（NFT 项目为独立系统，本项目不负责 NFT 业务本体）。业务关系如下：

- **赞助商（Sponsor）**：NFT 的生产厂商/发行方，为自己的用户发放 NFT 产品（盲盒）
- **用户（User）**：NFT 持有人（Holder），参与投票来决策每个 NFT 的稀有度（Rarity）
- **投票目标**：围绕 NFT 稀有度的决策投票
- **核心投票模型**：采用“比特承诺（Bit Commitment）/两阶段提交”模型：
  1. **第 1 阶段 Commit**：用户先提交承诺（commitment），隐藏真实投票内容
  2. **第 2 阶段 Reveal**：在规定时间/条件满足后揭示真实投票数据

本项目聚焦于“钱包能力”：

- 负责 **安全地产生/保存投票原始数据**（在本地加密保存）
- 负责 **提交承诺与在第 2 阶段自动揭示**（自动发送 reveal 数据）
- 不负责 NFT 盲盒项目的业务 UI、NFT 发行/流转、稀有度算法等

### 2.1.2 关键体验目标（第二阶段自动发送，无需二次签名）

本项目的关键目标之一（与具体业务无关的“钱包通用能力”）：

- 用户在第 1 阶段完成一次签名/授权后，在第 2 阶段 **自动完成第二阶段交易发送**，不要求用户再次手动签名。
  - 说明：自动发送的前提是用户在第 1 阶段已经对“后续自动发送”做过明确授权，并满足安全边界（见第 9 章）。

### 2.2 设计原则（需求级）

- **无自建后端**：不落地任何用户数据到自有服务器
- **默认安全**：敏感数据默认本地加密存储；默认不导出明文密钥
- **可用性优先**：外部服务不可用时必须提供可理解的降级提示/路径
- **可测试性**：每个核心需求必须有可执行的验收与测试条目

### 2.3 系统边界（In/Out of Scope）

- **In Scope**：钱包 UI、账户抽象交互、Provider、基础资产/交易、赞助商机制（含申请/审核）、可插拔存储基础
- **Out of Scope（当前）**：自建后端、中心化账号体系、推送通知依赖后端、强依赖硬件钱包的完整流程

### 2.4 需求概览（从“系统概述（旧）”迁入）

> 本小节承接原 `系统概述（旧）.md` 中的“系统定位/目标/特点/约束”的**需求级摘要**，用于统一对齐需求边界。

#### 2.4.1 产品定位（需求视角）

- **完全无服务端**：不提供自有 REST/WebSocket 业务 API；仅依赖外部 RPC/Bundler/Paymaster
- **智能合约钱包（AA）**：基于 Kernel / ERC-4337；交易以 UserOperation 为主路径
- **三路径入口**：A（极简/无 EOA）/ B（标准/有 EOA）/ C（赞助商）
- **面向业务示例**：NFT 盲盒投票仅作为场景背景；本项目聚焦钱包通用能力（两阶段提交第二阶段自动发送）

#### 2.4.2 系统目标（需求视角）

- **功能目标**：
  - 三路径账户创建与管理
  - 资产查看与交易发送（userOp）
  - DApp Provider 集成（EIP-1193 / EIP-6963）
  - 两阶段提交/比特承诺通用能力（第二阶段可自动发送，无需二次签名）
- **体验目标**：
  - 新手低门槛（路径A）
  - 明确的交互确认与错误提示
- **技术目标**：
  - 本地加密存储、类型安全、可观测性与可测试性

### 2.5 关键约束与风险（需求视角）

- **PWA 约束**：无后台常驻任务；自动发送行为必须受前台状态/权限/策略约束
- **外部服务可用性**：Bundler/Paymaster/RPC 可能不可用，必须有清晰的失败提示与补救路径
- **安全与隐私**：敏感数据仅本地加密存储；默认不导出明文密钥；DApp 权限最小化

---

## 3. 角色与使用场景

### 3.1 角色定义

- **R-USER-A（路径A用户 / 新手）**：无 EOA、无 Gas、希望零门槛使用钱包
- **R-USER-B（路径B用户 / 标准）**：已有或愿意创建/导入 EOA，追求兼容性与自付 Gas 能力
- **R-SPONSOR（赞助商）**：业务侧的发行/运营方（例如 NFT 发行方）；愿意代付 Gas，提供审核/创建服务并可设置规则与渠道
- **R-DAPP（外部 DApp）**：通过 `window.ethereum` 与钱包交互（EIP-1193 / EIP-6963）
- **R-OPS（运维/发布人员）**：负责静态部署、环境变量配置、可用性检查

### 3.2 核心用户旅程（User Journey）

- **UJ-01 路径A创建账户（申请制）**
  - 选择路径A → 本地生成并加密保存控制密钥 → 预测账户地址 → 选择赞助商 → 提交申请 → 轮询/查看状态 → 创建完成进入钱包
- **UJ-02 路径B创建账户（自付 Gas 或 申请赞助）**
  - 选择路径B → 创建/导入 EOA → 本地生成并加密保存控制密钥 → 选择 Gas 支付方式（自付/赞助）→ 创建完成进入钱包
- **UJ-03 赞助商注册与审核**
  - 选择路径C → 配置 Gas 支付账户与规则 → 完成注册 → 查看申请列表 → 审核 → 代付部署 → 更新状态
- **UJ-04 DApp 连接与交易**
  - DApp 发起连接 → 钱包授权 → DApp 发起签名/交易 → 钱包展示确认 → 通过 userOp 发送 → 返回结果

### 3.3 关键用例列表（Use Cases）

- **UC-01**：创建/导入钱包与解锁（密码会话）
- **UC-02**：三路径账户创建（A/B/C）
- **UC-03**：查看资产与交易记录
- **UC-04**：发送交易（userOp）
- **UC-05**：DApp 连接、签名与交易授权（Provider）
- **UC-06**：赞助商注册、审核与代付部署
- **UC-07**：申请状态查询与轮询
- **UC-08**：日志/错误导出（用于排障）
> 业务侧用例示例（如 NFT 稀有度投票）属于外部项目，本项目仅提供两阶段提交/自动发送等通用钱包能力，因此不在本用例列表中定义。

---

## 4. 功能需求

本章节采用 MUST / SHOULD / COULD 三级优先级（验收以 MUST 为硬标准）。

### 4.1 账户与会话（FR-AUTH）

- **FR-AUTH-01（MUST）**：用户可设置钱包访问密码；敏感数据必须以该密码派生密钥加密保存
- **FR-AUTH-02（MUST）**：解锁后形成会话；会话超时或用户手动锁定后，敏感能力不可用（签名/导出等）
- **FR-AUTH-03（SHOULD）**：支持自动锁定时间配置

### 4.2 账户创建（三路径）（FR-ACCT）

- **FR-ACCT-01（MUST）**：提供欢迎页，用户可选择路径 A/B/C
- **FR-ACCT-02（MUST）**：路径A：本地生成智能账户控制密钥并加密保存；支持预测账户地址；支持提交申请与状态查询
- **FR-ACCT-03（MUST）**：路径B：支持创建/导入 EOA；支持选择自付 Gas 或 申请赞助；创建后可管理双账户视图
- **FR-ACCT-04（MUST）**：路径C：支持赞助商注册（含 Gas 支付账户配置、规则配置）；支持申请审核与代付部署
- **FR-ACCT-05（SHOULD）**：支持路径转换（A→B、B→C 等），并明确告知影响范围

### 4.3 资产与交易（FR-TX）

- **FR-TX-01（MUST）**：展示当前账户资产余额（原生币与常用代币）
- **FR-TX-02（MUST）**：发送交易必须通过 ERC-4337 UserOperation（Bundler 发送）
- **FR-TX-03（MUST）**：交易前必须展示确认信息（目标地址、金额/数据、费用估算、链）
- **FR-TX-04（SHOULD）**：支持批量交易（一次签名多调用）

### 4.4 DApp Provider（FR-PROVIDER）

- **FR-PROVIDER-01（MUST）**：实现 EIP-1193 Provider（`window.ethereum.request` 等）
- **FR-PROVIDER-02（MUST）**：支持 EIP-6963 钱包发现（如已实现）
- **FR-PROVIDER-03（MUST）**：DApp 请求必须进入交互队列，用户可批准/拒绝
- **FR-PROVIDER-04（MUST）**：支持标准签名方法（至少 personal_sign / eth_signTypedData）

### 4.5 赞助商与申请（FR-SPONSOR）

- **FR-SPONSOR-01（MUST）**：用户可查看/选择赞助商（列表/邀请码）
- **FR-SPONSOR-02（MUST）**：申请记录可被赞助商读取并审核；审核结果可被用户查询
- **FR-SPONSOR-03（MUST）**：赞助商可代付部署账户并更新链上/存储状态
- **FR-SPONSOR-04（SHOULD）**：提供赞助商风控规则（限额/频率等）与审核原因记录

### 4.6 可插拔存储与链上索引（FR-STORAGE）

- **FR-STORAGE-01（MUST）**：提供统一存储接口（add/get/isValid），支持默认 IPFS 与扩展自定义存储
- **FR-STORAGE-02（MUST）**：申请详情与审核记录必须可通过存储标识符检索
- **FR-STORAGE-03（MUST）**：链上索引（如 ApplicationRegistry）必须保存存储标识符、存储类型与状态
- **FR-STORAGE-04（SHOULD）**：本地缓存与批量获取（如 provider 支持）用于降低延迟与提高可用性

### 4.7 两阶段提交/比特承诺通用能力（FR-2PC）

> 本章节定义钱包提供的“通用两阶段提交（Commit/Reveal）能力”。  
> 业务侧（例如 NFT 稀有度投票）仅作为使用示例存在，不属于本项目的业务功能需求。

- **FR-2PC-01（MUST）**：钱包必须支持“两阶段提交/比特承诺”工作流：Commit → Reveal
- **FR-2PC-02（MUST）**：Commit 阶段必须能生成承诺（commitment），并发送第一阶段交易（userOp）
- **FR-2PC-03（MUST）**：第二阶段必须能使用第一阶段保存的原始数据自动生成第二阶段调用数据并发送交易
- **FR-2PC-04（MUST）**：第二阶段的自动发送必须满足：用户在第一阶段已对“后续自动发送”进行明确授权
- **FR-2PC-05（MUST）**：第二阶段自动发送不得要求用户再次手动签名；实现方式可为（但不限于）：
  - 会话密钥/临时授权（Session Key）
  - 预授权规则（仅允许对特定合约/方法/参数范围自动执行）
  - 其他不降低安全边界的方案
- **FR-2PC-06（MUST）**：钱包必须将第二阶段所需的原始数据以本地加密方式保存，并在第二阶段可解密使用
- **FR-2PC-07（SHOULD）**：钱包应提供“两阶段任务”的状态可视化（例如：已提交、等待条件、已自动发送、失败可重试）
- **FR-2PC-08（SHOULD）**：第二阶段自动发送失败时，钱包必须给出可操作的补救路径（重试/改用手动签名/导出日志）

---

## 5. 数据与存储需求

（待补充：本地加密、IndexedDB/LocalStorage、可插拔存储、链上索引、数据保留与清理）

### 5.1 两阶段提交任务数据本地保存（DATA-2PC）

- **DATA-2PC-01（MUST）**：必须保存足以完成第二阶段的任务数据（例如原始数据、salt/nonce、commitment、合约地址、链 ID、时间窗口/条件等）
- **DATA-2PC-02（MUST）**：上述数据必须以本地加密方式持久化（如 IndexedDB + 加密封装），并可在会话解锁后解密使用
- **DATA-2PC-03（SHOULD）**：应支持数据生命周期管理（过期/已完成自动清理，或由用户手动清理）

---

## 6. 外部接口需求

（待补充：EIP-1193 Provider、EIP-6963、RPC/Bundler/Paymaster、合约接口范围、错误码）

---

## 7. 非功能性需求

### 7.1 性能（NFR-PERF）

- **NFR-PERF-01（MUST）**：首屏可交互时间需可度量（至少可通过浏览器性能面板/日志定位瓶颈）
- **NFR-PERF-02（SHOULD）**：路由级代码分割与懒加载应启用，降低初始包体
- **NFR-PERF-03（SHOULD）**：长列表使用虚拟滚动，避免渲染卡顿

### 7.2 可用性与降级（NFR-AVAIL）

- **NFR-AVAIL-01（MUST）**：RPC / Bundler / Paymaster 不可用时必须给出明确错误与建议（重试/切换/自付等）
- **NFR-AVAIL-02（SHOULD）**：对外部服务请求应具备超时与重试策略（指数退避）
- **NFR-AVAIL-03（SHOULD）**：关键状态（例如申请状态）应具备缓存与“最后更新时间”提示

### 7.3 兼容性（NFR-COMPAT）

- **NFR-COMPAT-01（MUST）**：支持主流现代浏览器（Chrome/Firefox/Safari/Edge 的现代版本）
- **NFR-COMPAT-02（MUST）**：Provider 行为需兼容常见 DApp（至少覆盖连接、签名、发送交易三类）

### 7.4 可维护性与可测试性（NFR-MAINT）

- **NFR-MAINT-01（MUST）**：需求必须可追踪到测试用例（见第 11 章）
- **NFR-MAINT-02（SHOULD）**：核心服务（Account/Tx/Storage/Sponsor/Provider）应具备单元测试或可替代的可验证脚本

---

## 8. 错误处理与可观测性需求

### 8.1 错误分类（OBS-ERR）

- **OBS-ERR-01（MUST）**：错误至少分为：网络/外部服务、合约调用、校验/用户输入、存储/加密、未知异常
- **OBS-ERR-02（MUST）**：对用户展示的错误信息必须可理解且可行动（如“检查网络/切换 RPC/稍后重试”）

### 8.2 日志与导出（OBS-LOG）

- **OBS-LOG-01（SHOULD）**：日志支持等级（DEBUG/INFO/WARN/ERROR）
- **OBS-LOG-02（SHOULD）**：支持导出日志（用于问题定位与用户反馈）

---

## 9. 安全与合规需求

### 9.1 密钥与敏感数据（SEC-KEY）

- **SEC-KEY-01（MUST）**：私钥/敏感信息必须本地加密存储；不得以明文写入持久化存储
- **SEC-KEY-02（MUST）**：默认不导出明文密钥；如提供导出能力必须二次确认并明确风险
- **SEC-KEY-03（SHOULD）**：支持密码修改/轮换后的重加密流程（失败可回滚）

### 9.2 DApp 权限与交互（SEC-DAPP）

- **SEC-DAPP-01（MUST）**：DApp 请求需显式授权，最小权限原则
- **SEC-DAPP-02（MUST）**：签名/交易确认页必须展示关键信息（origin、目标、数据摘要、链）

### 9.3 Web 安全（SEC-WEB）

- **SEC-WEB-01（SHOULD）**：开启合理的 CSP，降低 XSS 风险
- **SEC-WEB-02（SHOULD）**：对外部输入进行校验/转义，避免注入类问题

---

## 10. 验收标准与测试大纲

### 10.1 验收原则

- 每个 MUST 需求必须有可验证的验收步骤与预期结果
- 验收以“关键路径端到端可跑通”为主：创建账户 → 资产展示 → 交易发送 → DApp 连接/签名

### 10.2 关键验收用例（示例）

- **AT-01 路径A创建**：能完成申请提交、状态查询，最终进入钱包且账户可用
- **AT-02 路径B自付创建**：能创建/导入 EOA，完成部署并进入钱包
- **AT-03 发送交易**：能构造 userOp 并通过 Bundler 成功上链（或给出清晰失败原因）
- **AT-04 DApp 连接与签名**：DApp 可连接并完成标准签名请求
- **AT-05 赞助商审核**：赞助商可读取申请、审核并代付部署，用户可见状态变化
- **AT-06 两阶段提交（第二阶段自动发送）**：
  - 用户完成第一阶段后，在第二阶段条件满足时钱包可自动发送第二阶段交易（无需用户二次签名）
  - 自动发送失败时提供可重试/可手动补救的路径，并能导出日志定位原因

### 10.3 测试范围（建议）

- **单元测试**：加密/存储校验、类型/参数校验、关键业务方法
- **集成测试**：Provider 请求流、userOp 构造与发送、存储与链上索引联动
- **端到端测试**：三路径创建、交易流程、社交恢复/插件流程（如已实现）

---

## 11. 需求追踪矩阵（对齐检查清单）

本章用于将 SRS 编号与 `docs/check_list.md` 对齐，形成从需求→实现→测试的闭环。

### 11.1 追踪表（模板）

| SRS ID | 需求摘要 | check_list 位置（章节/条目） | 测试用例 ID | 状态 |
|-------|----------|-----------------------------|------------|------|
| FR-ACCT-01 | 三路径入口 | 3.x / 账户创建相关条目 | AT-01/AT-02 | - |
| FR-PROVIDER-01 | EIP-1193 Provider | 3.x / DApp 集成条目 | AT-04 | - |
| FR-STORAGE-01 | 可插拔存储接口 | 3.x / 存储条目 | AT-05 | - |

> 后续可逐步补齐：将 check_list 的关键 MUST 条目映射到 SRS ID，并为每个 SRS ID 绑定至少一个测试用例。

