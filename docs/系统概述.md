# AnDaoWallet HTML5 版本系统概述

## 文档信息

- **项目名称**: AnDaoWallet HTML5 版本
- **文档版本**: 1.0
- **编制日期**: 2024年
- **文档状态**: 正式版
- **基于版本**: AnDaoWallet 0.12.308

## 目录

1. [系统定位](#1-系统定位)
2. [系统目标](#2-系统目标)
3. [技术栈](#3-技术栈)
4. [系统特点](#4-系统特点)
5. [与扩展版本的对比](#5-与扩展版本的对比)
6. [运行环境](#6-运行环境)
7. [核心功能](#7-核心功能)
8. [设计约束与风险](#8-设计约束与风险)

---

## 1. 系统定位

### 1.1 产品定位

**AnDaoWallet HTML5 版本**是基于账户抽象（ERC-4337）技术构建的智能合约钱包 PWA 应用，**无自建服务端，所有状态与密钥均存储在本地/链上**。与传统的 EOA（外部账户）钱包不同，AnDaoWallet 使用 Kernel 智能合约账户，提供更强大的功能、更高的安全性和更好的用户体验。

**核心定位**：
- ✅ **完全独立的智能合约钱包**：架构完全独立，不依赖任何传统钱包（如 Keplr、MetaMask）的核心代码
- ✅ **UI 设计参考**：界面设计和用户体验参考 Keplr 钱包，但代码完全独立实现
- ✅ **基于 ERC-4337 账户抽象标准**：使用 Kernel 智能合约账户框架
- ✅ **直接使用 kernel-dev 源码**：不通过 SDK，直接使用 `../kernel-dev` 中的合约接口和类型定义
- ✅ **支持社交恢复、Gas 代付、批量交易等高级功能**

### 1.2 应用场景

AnDaoWallet HTML5 版本适用于以下场景：

1. **智能合约钱包用户**: 需要社交恢复、Gas 代付等高级功能的用户
2. **复杂链上交互**: 需要支持比特承诺、延迟交易、条件交易等复杂场景
3. **移动设备用户**: 在移动浏览器中使用钱包功能，无需安装扩展
4. **跨平台访问**: 在任何支持现代 Web 标准的设备上使用
5. **DApp 开发者**: 需要可编程钱包功能的 DApp 开发者
6. **受限环境**: 在企业环境或受限制的浏览器环境中使用

### 1.3 设计原则

- **账户抽象优先**: 完全基于智能合约账户，不依赖传统 EOA
- **模块化设计**: 支持插件系统，可扩展钱包功能
- **用户体验优先**: 提供流畅的 Web 应用体验，支持 Gas 代付降低使用门槛
- **安全性增强**: 支持社交恢复，私钥丢失不再是资产末日
- **可编程性**: 支持高级交易构造器，满足复杂业务场景需求
- **性能优化**: 针对 Web 环境优化加载和运行性能

---

## 2. 系统目标

### 2.1 功能目标

- ✅ **智能合约账户**: 基于 Kernel 智能合约账户，支持 ERC-4337 标准
- ✅ **社交恢复**: 支持守护人机制，私钥丢失可通过社交恢复找回账户
- ✅ **Gas 代付**: 支持 Paymaster，第三方可为用户支付 Gas 费用
- ✅ **批量交易**: 支持一次签名执行多个交易
- ✅ **高级交易构造器**: 插件化框架，支持比特承诺、延迟交易等复杂交互
- ✅ **多链支持**: 支持所有 EVM 兼容链（通过 Kernel 部署）
- ✅ **插件系统**: 支持 ERC-7579 插件，可扩展钱包功能
- ✅ **DApp 集成**: 提供标准的钱包 Provider 接口，支持 DApp 集成

### 2.2 技术目标

- ✅ **高性能**: 优化代码分割，减少初始加载时间
- ✅ **响应式设计**: 支持桌面端和移动端
- ✅ **浏览器兼容**: 支持主流现代浏览器（Chrome、Firefox、Safari、Edge）
- ✅ **安全性**: 密钥本地存储，支持硬件钱包，遵循安全最佳实践

### 2.3 用户体验目标

- ✅ **快速启动**: 优化首屏加载时间
- ✅ **流畅交互**: 60fps 的交互体验
- ✅ **清晰导航**: 直观的界面和导航设计
- ✅ **错误处理**: 完善的错误提示和处理机制

---

## 3. 技术栈

### 3.1 核心框架

- **React 18.2.0**: 现代化的 UI 框架，支持并发特性
- **TypeScript 5.0.4**: 类型安全的开发语言
- **MobX 6.10.0**: 响应式状态管理
- **React Router**: 客户端路由管理

### 3.2 构建工具

- **Webpack 5** 或 **Vite**: 模块打包和构建工具
- **Babel**: JavaScript 编译和转译
- **ESLint + Prettier**: 代码规范和格式化

### 3.3 UI 和样式

- **Styled Components**: CSS-in-JS 样式方案
- **响应式设计**: 基于 Flexbox 和 Grid 的布局
- **组件库**: 复用扩展版本的 UI 组件系统

### 3.4 账户抽象技术

- **Kernel v3**: 智能合约账户框架（ERC-4337 兼容），直接使用 `../kernel-dev` 源码
- **链交互库**: viem 或 ethers.js，用于与链和合约交互
- **Bundler**: ERC-4337 Bundler 网络服务（支持多服务商故障转移）
- **Paymaster**: Gas 代付服务（可选）
- **EntryPoint**: ERC-4337 EntryPoint 合约（通过 kernel-dev 接口访问）
- **类型绑定**: 使用 TypeChain 从 kernel-dev 合约生成 TypeScript 类型

### 3.5 加密和存储

- **Web Crypto API**: 浏览器原生加密 API（AES-GCM）
- **IndexedDB**: 本地数据持久化存储
- **LocalStorage**: 轻量级配置存储

### 3.6 区块链支持

- **优先链**: Mantle Network（EVM 兼容，优先支持）
- **次要链**: Injective Network（需要验证 ERC-4337 支持情况）
- **支持策略**: MVP 阶段仅支持 Mantle，后续根据 Injective 支持情况决定
- **RPC 节点**: 支持标准 Ethereum JSON-RPC

---

## 4. 系统特点

### 4.1 架构特点

#### 4.1.1 完全独立的设计

- **架构完全独立**: 不依赖任何传统钱包（如 Keplr、MetaMask）的核心代码
- **基于账户抽象**: 完全基于 ERC-4337 和 Kernel 智能合约账户
- **UI 设计参考**: 界面设计参考 Keplr 钱包，但代码完全独立实现
- **直接使用 kernel-dev**: 不通过 SDK，直接使用 `../kernel-dev` 中的合约接口和类型定义
- **无中心化后端**: 只依赖链上 RPC、Bundler、Paymaster 等外部服务；不存储用户数据到自有服务器
- **PWA 约束**: 前台优先，后台监控与推送能力有限

#### 4.1.2 模块化设计

- 清晰的模块边界和依赖关系
- 独立的 Web 应用层，处理路由、导航等 Web 特有功能
- 核心服务层：账户管理、交易中继、消息签名、链管理等
- 适配器层：存储适配器、Provider 适配器

#### 4.1.3 性能优化

- 代码分割和懒加载
- 资源压缩和缓存策略
- 虚拟滚动等性能优化技术

### 4.2 安全特点

#### 4.2.1 密钥安全

- 密钥仅在本地存储，不传输到服务器
- 使用 AES 加密存储敏感数据
- 硬件钱包支持为规划项（WebUSB/WebHID 集成待实现）

#### 4.2.2 通信安全

- HTTPS 传输
- 安全的跨域通信机制
- DApp 权限管理

#### 4.2.3 运行时安全

- Content Security Policy (CSP)
- XSS 防护
- 安全的第三方库使用

### 4.3 用户体验特点

#### 4.3.1 响应式设计

- 支持桌面端和移动端
- 自适应布局
- 触摸友好的交互设计

#### 4.3.2 离线支持

- Service Worker（可选）
- 本地数据缓存
- 离线功能提示

#### 4.3.3 国际化

- 多语言支持
- 时区和货币格式化
- 本地化内容

---

## 5. 与传统钱包的对比

### 5.1 账户类型对比

| 特性 | AnDaoWallet (智能合约钱包) | 传统 EOA 钱包 (如 MetaMask) |
|------|---------------------------|---------------------------|
| **账户类型** | 智能合约账户（Kernel） | 外部账户（EOA） |
| **地址生成** | 由 Factory 合约部署 | 从私钥派生 |
| **资产存储** | 智能合约账户持有 | 账户地址直接持有 |
| **控制方式** | 多种方式（签名、社交恢复等） | 仅私钥签名 |

### 5.2 功能对比

| 功能 | AnDaoWallet | 传统 EOA 钱包 |
|------|------------|--------------|
| **私钥恢复** | ⚠️ 框架完成，投票/执行待补全 | ❌ 不支持 |
| **Gas 代付** | ✅ 支持 Paymaster | ❌ 不支持 |
| **批量交易** | ✅ 一次签名 | ❌ 需要多次签名 |
| **条件交易** | ⚠️ 规划中 | ❌ 不支持 |
| **延迟交易** | ⚠️ 规划中 | ❌ 不支持 |
| **插件扩展** | ✅ ERC-7579 插件 | ❌ 不支持 |
| **多重签名** | ✅ 原生支持 | ⚠️ 需要额外服务 |

### 5.3 安全性对比

| 安全特性 | AnDaoWallet | 传统钱包 |
|---------|------------|---------|
| **私钥丢失** | ✅ 可通过社交恢复 | ❌ 资产永久丢失 |
| **多重签名** | ✅ 原生支持 | ⚠️ 需要额外服务 |
| **权限管理** | ✅ 支持插件化权限 | ❌ 不支持 |
| **时间锁** | ✅ 支持插件实现 | ❌ 不支持 |

### 5.4 使用场景对比

**AnDaoWallet (智能合约钱包) 适合**:
- 需要社交恢复功能的用户
- 需要 Gas 代付的场景
- 需要批量交易的用户
- 需要复杂链上交互的 DApp
- 需要可编程钱包功能的开发者

**传统 EOA 钱包适合**:
- 简单的转账和交易
- 不需要高级功能的用户
- 需要浏览器扩展的场景

---

## 6. 运行环境

### 6.1 浏览器要求

**最低要求**:
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

**推荐版本**:
- Chrome 100+
- Firefox 100+
- Safari 15+
- Edge 100+

### 6.2 功能支持要求

- **WebAssembly**: 加密算法支持
- **IndexedDB**: 数据持久化
- **WebUSB / WebHID**: 硬件钱包支持（可选）
- **Fetch API**: 网络请求
- **Web Crypto API**: 加密操作

### 6.3 移动设备支持

- **iOS Safari**: iOS 14+
- **Android Chrome**: Android 7+
- **其他移动浏览器**: 根据 Web 标准支持情况

---

## 7. 核心功能

### 7.1 智能合约账户功能

1. **账户创建和管理** ✅
   - 创建 Kernel 智能合约账户（AccountManager）
   - 账户地址确定性预测（使用 Factory.getAddress）
   - 多账户管理（AccountStore）
   - 账户锁定/解锁（AuthService）

2. **社交恢复** ✅（框架完成）
   - 添加/移除守护人（GuardianService，基于插件实现）
   - 发起账户恢复（initiateRecovery）
   - 守护人投票（voteForRecovery）
   - 完成账户恢复（需要恢复插件支持）

3. **资产管理** ✅
   - 余额查询（智能合约账户余额，TokenService）
   - 代币管理（TokenService）
   - 转账功能（通过 UserOperation，TransactionRelayer）

### 7.2 账户抽象功能 ✅

- **UserOperation**: 构造和发送用户操作（TransactionRelayer）
- **Gas 代付**: 通过 Paymaster 支付 Gas（PaymasterService，基础支持）
- **批量交易**: 一次签名执行多个交易（TransactionRelayer.sendBatch）
- **Bundler 网络**: 与 Bundler 服务交互（BundlerClient，支持多服务商故障转移）

### 7.3 高级交易构造器 ✅

- **插件系统**: 支持 ERC-7579 插件（PluginService）
- **两阶段提交**: 提交和揭示承诺哈希，支持加密存储原始数据（TwoPhaseCommitService）
- **插件执行**: Executor 和 Hook 插件执行逻辑（已实现）
- **延迟交易**: 支持延迟执行交易（待实现）
- **条件交易**: 支持条件触发交易（待实现）

### 7.4 多链支持 ✅

- **EVM 兼容链**: 支持所有 EVM 兼容链（通过 Kernel 部署）
- **优先链**: Mantle Network（EVM 兼容，优先支持）
- **链管理**: 支持添加和切换链（ChainService：wallet_switchEthereumChain、wallet_addEthereumChain）
- **链适配器**: 统一的链配置接口（chains.ts）

### 7.5 DApp 集成 ✅

- **Provider 接口**: 标准的 Ethereum Provider（EIP-1193，ProviderAdapter）
- **钱包发现**: 兼容 EIP-6963 钱包发现标准
- **交互管理**: DApp 请求队列管理（InteractionStore）
- **交易签名**: 通过 UserOperation 签名和发送
- **消息签名**: 支持 eth_sign、personal_sign、eth_signTypedData（SignatureService）

### 7.6 安全功能 ✅

- **社交恢复**: 守护人机制恢复账户（GuardianService，框架完成）
- **加密存储**: 三特征密钥系统（StableThreeFeatureKey、TwoPhaseCommitEncryption）
- **权限管理**: 插件化权限系统（PluginService）
- **自动锁定**: 闲置自动锁定（AuthService）
- **安全提示**: 交易和操作安全提示（SettingsService）

---

## 总结

AnDaoWallet HTML5 版本是一个**完全独立的智能合约钱包**，基于账户抽象（ERC-4337）技术构建。它不依赖任何传统钱包的核心代码，完全基于 Kernel 智能合约账户实现。

### 核心优势

1. **完全独立**: 架构完全独立，不依赖 Keplr 或其他钱包的核心代码
2. **账户抽象**: 基于 ERC-4337 标准，使用 Kernel 智能合约账户
3. **功能完整**: 已实现账户管理、交易发送、消息签名、链管理、两阶段提交等核心功能
4. **标准兼容**: 实现标准的 Ethereum Provider 接口，兼容 EIP-6963 钱包发现
5. **安全可靠**: 支持加密存储、社交恢复框架、三特征密钥系统

### 实现状态

- ✅ **核心功能**: 账户管理、交易中继、消息签名、链管理
- ✅ **高级功能**: 两阶段提交（支持加密存储）、插件执行逻辑
- ✅ **DApp 集成**: Provider 适配器、Interaction Store
- ⚠️ **待完善**: kernel-dev 类型导入、硬件钱包支持、完整社交恢复

虽然在某些功能（如后台监控）上存在 Web 环境的限制，但通过合理的设计和实现，HTML5 版本能够满足大多数用户的使用需求，为用户提供安全、便捷的智能合约钱包体验。

---

## 8. 设计约束与风险

- **PWA 运行约束**：无后台长驻任务，链上轮询需在前台或受限的 Service Worker 内完成，后台监控能力弱于浏览器扩展版。
- **Bundler/Paymaster 可用性**：需提供「直连 EntryPoint + 自付 Gas」降级路径，否则在服务不可用时交易无法发送。
- **社交恢复与高级插件**：当前仅有框架，恢复投票/执行、延迟/条件交易需补全合约与前端交互。
- **硬件钱包**：未集成 WebUSB/WebHID，后续需要独立威胁建模与 UI 流程。
- **多链支持策略**：MVP 仅保障 Mantle；Injective 的 ERC-4337 支持需验证后再放量。
- **安全与隐私**：默认不导出明文密钥，导入/导出需二次确认；需补充密码轮换与全量重加密流程。
- **无后端存储**：所有敏感数据仅在本地加密存放；不得依赖自建 API 落地任何用户数据。

---

## 9. 已识别设计问题与改进计划

### 9.1 Bundler 单点与降级链路不完整

- **问题**：当前实现假设 Bundler/Paymaster 可用，仅在文档层面提出「直连 EntryPoint」方案，缺少具体的链路、签名域和 UI 引导，导致在 Bundler 故障或目标链暂未部署 Bundler 时，用户无法发送交易。
- **解决方案**：在 `TransactionRelayer` 内编排三段式策略：Bundler（含多节点轮询）→ RPC 直发（自付 Gas，自动重算 userOpHash）→ 手动导出 rawTransaction。配套 UI 需提示费用差异，并允许用户切换 Gas 资金来源。

### 9.2 社交恢复流程缺乏状态机

- **问题**：守护人模块仅暴露添加/移除接口，没有定义恢复流程的状态机（请求、投票、执行、取消）和最小安全延时，难以验证恢复完成条件。
- **解决方案**：在 `GuardianService` 与 `TwoPhaseCommitService` 之间增加恢复请求仓库，明确 `INITIATED → VOTING → EXECUTABLE → EXECUTED/REJECTED` 状态，并在 UI 中展示倒计时与需要的票数。

### 9.3 安全存储缺少密钥轮换路径

- **问题**：当用户修改密码或切换设备时，没有统一的主密钥轮换流程，易导致旧密钥残留或部分数据未重加密。
- **解决方案**：引入「主密钥版本号」并在 `SecurityVault` 中记录 metadata；密码变更时执行「双写+核对」机制，成功后再删除旧密钥快照。

### 9.4 多链支持策略与实现脱节

- **问题**：文档宣称“支持所有 EVM 链”，但 `chains.ts` 只配置 Mantle，Injective 仍待验证；缺少「实验性」标记与 RPC 健康检查。
- **解决方案**：将链分为 `stable/experimental` 两档，引入链级健康探针并在 UI 中提示「实验性功能」。默认仅展示稳定链，实验性链需要显式开启。

### 9.5 PWA 会话锁定与前后台事件冲突

- **问题**：Auto-lock 同时监听「无操作 5 分钟」和「标签页隐藏立即锁定」，在移动端切后台时会频繁打断操作；与社交恢复/批量交易等长流程不兼容。
- **解决方案**：拆分「安全锁定」与「体验锁定」两种策略：标签页隐藏仅进入受限模式（保留短期密钥，但需二次确认才能执行敏感操作），真正的自动锁定由空闲计时器触发。

