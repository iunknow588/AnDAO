# AnDaoWallet HTML5 版本开发指南

## 文档信息

- **项目名称**: AnDaoWallet HTML5 版本
- **文档版本**: 1.0
- **编制日期**: 2024年
- **文档状态**: 正式版

## 目录

1. [开发环境搭建](#1-开发环境搭建)
2. [项目结构说明](#2-项目结构说明)
3. [开发工作流](#3-开发工作流)
4. [代码规范](#4-代码规范)
5. [测试指南](#5-测试指南)
6. [调试技巧](#6-调试技巧)
7. [常见问题](#7-常见问题)

---

## 1. 开发环境搭建

### 1.1 系统要求

- **Node.js**: >= 18.0.0
- **包管理器**: Yarn 3.4.1+
- **操作系统**: macOS, Linux, Windows (WSL2 推荐)
- **浏览器**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

### 1.2 安装步骤

#### 1.2.1 克隆项目

```bash
git clone <repository-url>
cd AnDaoWallet
```

#### 1.2.2 安装依赖

```bash
# 安装项目依赖
yarn install

# 或者使用 npm (不推荐)
npm install
```

#### 1.2.3 验证安装

```bash
# 检查 Node.js 版本
node --version  # 应 >= 18.0.0

# 检查 Yarn 版本
yarn --version  # 应 >= 3.4.1

# 检查依赖安装
yarn workspaces list
```

### 1.3 开发工具推荐

#### 1.3.1 IDE / 编辑器

- **VS Code** (推荐)
  - 扩展: ESLint, Prettier, TypeScript
- **WebStorm**
- **Vim / Neovim** (配置 TypeScript LSP)

#### 1.3.2 浏览器开发工具

- **Chrome DevTools**: 调试、性能分析
- **React Developer Tools**: React 组件调试
- **Redux DevTools**: MobX 状态调试（通过 mobx-devtools）

---

## 2. 项目结构说明

### 2.1 目录结构

```
h5/
├── docs/                    # 文档目录
│   ├── README.md
│   ├── 系统概述.md
│   ├── 架构设计.md
│   ├── API接口文档.md
│   ├── 开发指南.md
│   └── 部署指南.md
├── src/                     # 源代码目录（待创建）
│   ├── components/          # UI 组件
│   ├── pages/               # 页面组件
│   ├── stores/              # MobX Stores
│   ├── services/            # 业务服务
│   ├── adapters/            # 适配器
│   ├── utils/               # 工具函数
│   ├── types/               # 类型定义
│   ├── styles/              # 样式文件
│   ├── App.tsx              # 应用入口
│   └── index.tsx            # 入口文件
├── public/                  # 静态资源
├── package.json
├── tsconfig.json
├── webpack.config.js        # 或 vite.config.ts
└── README.md
```

### 2.2 关键文件说明

#### 2.2.1 package.json

```json
{
  "name": "@andaowallet/h5",
  "version": "1.0.0",
  "scripts": {
    "dev": "webpack serve",      // 开发服务器
    "build": "webpack --mode production",  // 生产构建
    "test": "jest",              // 运行测试
    "lint": "eslint src",        // 代码检查
    "type-check": "tsc --noEmit" // 类型检查
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.0.0",
    "mobx": "^6.10.0",
    "mobx-react-lite": "^3.4.0",
    // ... 共享的核心包
    "@keplr-wallet/crypto": "workspace:*",
    "@keplr-wallet/types": "workspace:*",
    "@keplr-wallet/common": "workspace:*"
  }
}
```

#### 2.2.2 tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "react-jsx",
    "moduleResolution": "node",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

---

## 3. 开发工作流

### 3.1 启动开发服务器

```bash
# 启动开发服务器
yarn dev

# 或者指定端口
yarn dev --port 3000
```

开发服务器将在 `http://localhost:3000` 启动，支持热模块替换（HMR）。

### 3.2 开发流程

1. **创建功能分支**
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. **编写代码**
   - 遵循代码规范
   - 编写类型定义
   - 添加注释

3. **运行测试**
   ```bash
   yarn test
   ```

4. **类型检查**
   ```bash
   yarn type-check
   ```

5. **代码检查**
   ```bash
   yarn lint
   ```

6. **提交代码**
   ```bash
   git add .
   git commit -m "feat: your feature description"
   ```

### 3.3 代码审查流程

1. 推送分支到远程
2. 创建 Pull Request
3. 代码审查
4. 通过后合并到主分支

---

## 4. 代码规范

### 4.1 TypeScript 规范

#### 4.1.1 类型定义

```typescript
// ✅ 好的做法
interface User {
  id: string;
  name: string;
  email: string;
}

function getUser(id: string): Promise<User> {
  // ...
}

// ❌ 避免使用 any
function processData(data: any): any {
  // ...
}
```

#### 4.1.2 命名规范

- **接口**: PascalCase (如 `UserProfile`)
- **类型别名**: PascalCase (如 `UserStatus`)
- **变量/函数**: camelCase (如 `getUserData`)
- **常量**: UPPER_SNAKE_CASE (如 `MAX_RETRY_COUNT`)
- **组件**: PascalCase (如 `UserProfile`)

### 4.2 React 规范

#### 4.2.1 组件定义

```typescript
// ✅ 函数组件（推荐）
interface UserCardProps {
  user: User;
  onEdit?: (user: User) => void;
}

export function UserCard({ user, onEdit }: UserCardProps) {
  return (
    <div className="user-card">
      <h3>{user.name}</h3>
      {/* ... */}
    </div>
  );
}

// ✅ 使用 React.memo 优化性能
export const UserCard = React.memo(function UserCard({ user, onEdit }: UserCardProps) {
  // ...
});
```

#### 4.2.2 Hooks 使用

```typescript
// ✅ 好的做法
function UserProfile({ userId }: { userId: string }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    fetchUser(userId).then(setUser).finally(() => setLoading(false));
  }, [userId]);
  
  if (loading) return <Loading />;
  if (!user) return <NotFound />;
  
  return <UserDetails user={user} />;
}

// ❌ 避免在循环/条件中使用 Hooks
if (condition) {
  const [state, setState] = useState(); // ❌ 错误
}
```

### 4.3 MobX 规范

#### 4.3.1 Store 定义

```typescript
// ✅ 好的做法
class UserStore {
  @observable users: User[] = [];
  @observable loading = false;
  
  @computed
  get userCount(): number {
    return this.users.length;
  }
  
  @action
  async fetchUsers(): Promise<void> {
    this.loading = true;
    try {
      this.users = await api.getUsers();
    } finally {
      this.loading = false;
    }
  }
}

export const userStore = new UserStore();
```

#### 4.3.2 Store 使用

```typescript
// ✅ 在组件中使用
function UserList() {
  const { users, loading, fetchUsers } = useStore(userStore);
  
  useEffect(() => {
    fetchUsers();
  }, [fetchUsers]);
  
  if (loading) return <Loading />;
  return <List items={users} />;
}
```

### 4.4 文件组织

```
src/
├── components/          # 可复用组件
│   ├── Button/
│   │   ├── index.tsx
│   │   ├── Button.tsx
│   │   └── Button.styled.ts
│   └── Card/
├── pages/              # 页面组件
│   ├── HomePage.tsx
│   └── WalletPage.tsx
├── stores/             # MobX Stores
│   ├── UserStore.ts
│   └── WalletStore.ts
└── utils/              # 工具函数
    ├── format.ts
    └── validation.ts
```

### 4.5 导入顺序

```typescript
// 1. React 和相关库
import React, { useState, useEffect } from 'react';
import { observer } from 'mobx-react-lite';

// 2. 第三方库
import styled from 'styled-components';
import { useNavigate } from 'react-router-dom';

// 3. 项目内部模块（按层级）
import { Button } from '@/components/Button';
import { userStore } from '@/stores/UserStore';
import { formatAddress } from '@/utils/format';

// 4. 类型定义
import type { User } from '@/types';
```

---

## 5. 测试指南

### 5.1 测试框架

- **Jest**: 单元测试框架
- **React Testing Library**: React 组件测试
- **@testing-library/user-event**: 用户交互测试

### 5.2 单元测试

```typescript
// utils/format.test.ts
import { formatAddress } from './format';

describe('formatAddress', () => {
  it('should format address correctly', () => {
    const address = 'cosmos1abc123...';
    const formatted = formatAddress(address);
    expect(formatted).toBe('cosmos1abc...123');
  });
  
  it('should handle empty address', () => {
    expect(formatAddress('')).toBe('');
  });
});
```

### 5.3 组件测试

```typescript
// components/Button/Button.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { Button } from './Button';

describe('Button', () => {
  it('should render button text', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });
  
  it('should call onClick when clicked', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);
    
    fireEvent.click(screen.getByText('Click me'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

### 5.4 Store 测试

```typescript
// stores/UserStore.test.ts
import { UserStore } from './UserStore';

describe('UserStore', () => {
  let store: UserStore;
  
  beforeEach(() => {
    store = new UserStore();
  });
  
  it('should initialize with empty users', () => {
    expect(store.users).toEqual([]);
    expect(store.loading).toBe(false);
  });
  
  it('should fetch users', async () => {
    await store.fetchUsers();
    expect(store.users.length).toBeGreaterThan(0);
  });
});
```

### 5.5 运行测试

```bash
# 运行所有测试
yarn test

# 运行指定文件的测试
yarn test Button.test.tsx

# 监视模式
yarn test --watch

# 覆盖率
yarn test --coverage
```

---

## 6. 调试技巧

### 6.1 React DevTools

1. 安装 React Developer Tools 浏览器扩展
2. 打开浏览器开发者工具
3. 使用 "Components" 标签查看组件树和状态

### 6.2 MobX DevTools

```typescript
// 开发环境启用 MobX DevTools
if (process.env.NODE_ENV === 'development') {
  import('mobx-react-devtools').then((mobxDevtools) => {
    // 启用 DevTools
  });
}
```

### 6.3 网络请求调试

```typescript
// 使用浏览器 Network 标签
// 或使用代理工具（如 Charles、Fiddler）
```

### 6.4 状态调试

```typescript
// 在组件中添加日志
function MyComponent() {
  const store = useStore(myStore);
  
  useEffect(() => {
    console.log('Store state:', store);
  }, [store]);
  
  // ...
}
```

### 6.5 性能分析

```typescript
// 使用 React Profiler
import { Profiler } from 'react';

function onRenderCallback(id, phase, actualDuration) {
  console.log('Component:', id, 'Phase:', phase, 'Duration:', actualDuration);
}

<Profiler id="MyComponent" onRender={onRenderCallback}>
  <MyComponent />
</Profiler>
```

---

## 7. 常见问题

### 7.1 构建错误

**问题**: TypeScript 类型错误

**解决**:
```bash
# 运行类型检查
yarn type-check

# 查看详细错误信息
yarn type-check --verbose
```

**问题**: 模块找不到

**解决**:
- 检查 `tsconfig.json` 的 `paths` 配置
- 检查 `package.json` 的依赖
- 重新安装依赖: `yarn install`

### 7.2 运行时错误

**问题**: Store 未初始化

**解决**:
```typescript
// 确保 Store 在使用前初始化
if (!store.initialized) {
  await store.init();
}
```

**问题**: 路由不匹配

**解决**:
- 检查路由配置
- 检查浏览器地址栏 URL
- 使用 React Router 的 `<Navigate>` 组件重定向

### 7.3 性能问题

**问题**: 组件渲染过多

**解决**:
- 使用 `React.memo` 包装组件
- 使用 `useMemo` 和 `useCallback`
- 检查 MobX Store 的响应式更新

**问题**: 首屏加载慢

**解决**:
- 代码分割和懒加载
- 优化资源大小
- 使用 CDN

---

## 总结

本开发指南提供了 HTML5 版本的开发环境搭建、项目结构、开发工作流、代码规范、测试和调试的完整说明。开发时请遵循这些规范，确保代码质量和项目的可维护性。

如有问题，请参考其他文档或联系开发团队。

