# 两阶段提交加密功能说明

## 文档信息
- **创建日期**: 2024年
- **版本**: 1.0

---

## 一、功能概述

两阶段提交功能现在支持本地加密存储原始数据，使用三特征密钥系统进行加密。在承诺阶段，原始数据会被加密保存；在揭示阶段，数据会被自动解密并发送到智能合约。

---

## 二、三特征密钥系统

### 2.1 密钥组成

加密密钥由三个稳定特征组成：

1. **用户ID** (`userId`)
   - 用户注册的ID
   - 存储在 localStorage 中
   - 通过 `StableThreeFeatureKey.initialize(userId)` 设置

2. **程序硬编码** (`appCode`)
   - 固定值：`ANDAO_WALLET_H5_v1.0_2024_FIXED_CODE`
   - 硬编码在代码中，永不改变

3. **操作系统特征** (`osFeature`)
   - 从 `navigator.platform` 和 `navigator.userAgent` 获取
   - 只返回操作系统大类（WINDOWS, MACOS, LINUX, IOS, ANDROID）
   - 不包含版本号，避免系统升级影响

### 2.2 密钥生成流程

```
用户ID + 程序硬编码 + 操作系统特征 + 固定盐值
  ↓
SHA-256 哈希
  ↓
前32字节作为 AES-256-GCM 密钥
```

### 2.3 安全性

- ✅ 必须三个特征同时正确才能解密
- ✅ 使用 AES-256-GCM 加密（每次使用随机 IV）
- ✅ 即使恶意程序获得1-2个特征，也无法解密数据
- ✅ 数据在客户端加密，服务器只存储密文

---

## 三、使用流程

### 3.1 初始化密钥系统

在使用两阶段提交功能前，必须先初始化密钥系统：

```typescript
import { stableThreeFeatureKey } from '@/services/StableThreeFeatureKey';

// 初始化（设置用户ID）
await stableThreeFeatureKey.initialize('user123');
```

### 3.2 承诺阶段（第一阶段）

```typescript
import { twoPhaseCommitService } from '@/services/TwoPhaseCommitService';
import { transactionRelayer } from '@/services/TransactionRelayer';

// 1. 准备原始数据
const originalData = 'my secret vote data';

// 2. 生成承诺哈希
const commitmentHash = await twoPhaseCommitService.generateCommitmentHash(originalData);

// 3. 调用合约的 commit 方法（第一阶段）
const commitTxHash = await transactionRelayer.sendTransaction(
  accountAddress,
  chainId,
  contractAddress,
  encodeCommitCallData(commitmentHash, defaultValue),
  signerPrivateKey
);

// 4. 创建任务（自动加密原始数据）
const task = await twoPhaseCommitService.createTask(
  chainId,
  contractAddress,
  commitmentHash,
  commitTxHash,
  originalData, // 原始数据会被加密保存
  accountAddress
);
```

### 3.3 揭示阶段（第二阶段）

```typescript
// 当合约状态满足条件时，自动或手动揭示

// 方式1：自动揭示（从加密数据中解密）
const revealTxHash = await twoPhaseCommitService.reveal(
  taskId,
  signerPrivateKey
  // 不提供 overrideData，会自动从任务中解密
);

// 方式2：手动提供数据
const revealTxHash = await twoPhaseCommitService.reveal(
  taskId,
  signerPrivateKey,
  'my secret vote data' // 手动提供原始数据
);
```

---

## 四、API 说明

### 4.1 StableThreeFeatureKey

#### `initialize(userId: string): Promise<boolean>`
初始化密钥系统，设置用户ID。

#### `getUserKey(): Promise<CryptoKey>`
获取用户加密密钥（AES-256-GCM）。

#### `validate(): Promise<boolean>`
验证系统是否可用。

#### `getFeaturesSummary(): FeatureSummary`
获取特征摘要（用于调试）。

#### `clearUserId(): void`
清除用户ID（用于登出等场景）。

### 4.2 TwoPhaseCommitEncryption

#### `initialize(userId: string): Promise<boolean>`
初始化加密服务。

#### `encryptData(data: string | Hex): Promise<EncryptedData>`
加密原始数据。

#### `decryptData(encrypted: EncryptedData): Promise<string>`
解密数据。

### 4.3 TwoPhaseCommitService

#### `generateCommitmentHash(data: string | Hex): Promise<Hash>`
生成承诺哈希（SHA-256）。

#### `createTask(chainId, contractAddress, commitmentHash, firstPhaseTxHash, originalData, ...): Promise<TwoPhaseCommitTask>`
创建两阶段提交任务，自动加密原始数据。

#### `reveal(taskId, signerPrivateKey, overrideData?): Promise<Hash>`
揭示数据，自动解密并发送到合约。

---

## 五、数据存储结构

### 5.1 TwoPhaseCommitTask

```typescript
interface TwoPhaseCommitTask {
  id: string;
  chainId: number;
  contractAddress: string;
  accountAddress?: string;
  firstPhaseTxHash: string;
  commitmentHash: string;
  encryptedData?: {
    iv: string;           // Base64 编码的 IV
    ciphertext: string;   // Base64 编码的密文
    timestamp: number;    // 加密时间戳
  };
  status: TwoPhaseCommitTaskStatus;
  createdAt: number;
  revealedAt?: number;
  revealedTxHash?: string;
}
```

### 5.2 存储位置

- 任务列表：存储在 IndexedDB（通过 `storageAdapter`）
- 用户ID：存储在 localStorage（`andaowallet_user_id`）

---

## 六、错误处理

### 6.1 常见错误

1. **用户ID未设置**
   ```
   Error: 用户ID未设置，请先调用 initialize(userId)
   ```
   **解决方案**: 调用 `stableThreeFeatureKey.initialize(userId)`

2. **数据解密失败**
   ```
   Error: 数据解密失败: ...
   ```
   **可能原因**:
   - 用户ID不匹配
   - 操作系统环境改变
   - 加密数据损坏
   
   **解决方案**: 
   - 确保使用相同的用户ID
   - 确保在相同的操作系统环境中
   - 如果数据已损坏，需要手动提供原始数据

3. **特征不完整**
   ```
   Error: 特征不完整
   ```
   **解决方案**: 检查三个特征是否都已设置

---

## 七、安全注意事项

### 7.1 用户ID管理

- 用户ID应该由用户输入，不应自动生成
- 用户ID应该持久化存储，避免丢失
- 建议在用户注册/登录时设置用户ID

### 7.2 数据恢复

- 如果用户ID丢失，加密数据将无法解密
- 建议在安全的地方备份用户ID
- 可以考虑提供数据恢复机制

### 7.3 环境变更

- 如果用户更换操作系统，需要重新设置用户ID或提供数据恢复机制
- 建议在创建任务时提示用户保存原始数据（可选）

---

## 八、使用示例

### 完整示例

```typescript
import { stableThreeFeatureKey } from '@/services/StableThreeFeatureKey';
import { twoPhaseCommitService } from '@/services/TwoPhaseCommitService';
import { transactionRelayer } from '@/services/TransactionRelayer';
import { encodeFunctionData } from 'viem';

// 1. 初始化密钥系统
await stableThreeFeatureKey.initialize('user123');

// 2. 准备数据
const originalData = 'vote_for_option_a';
const defaultValue = '0x';

// 3. 生成承诺哈希
const commitmentHash = await twoPhaseCommitService.generateCommitmentHash(originalData);

// 4. 第一阶段：提交承诺
const commitCallData = encodeFunctionData({
  abi: TWO_PHASE_COMMIT_ABI,
  functionName: 'commit',
  args: [commitmentHash, defaultValue],
});

const commitTxHash = await transactionRelayer.sendTransaction(
  accountAddress,
  chainId,
  contractAddress,
  commitCallData,
  signerPrivateKey
);

// 5. 创建任务（自动加密数据）
const task = await twoPhaseCommitService.createTask(
  chainId,
  contractAddress,
  commitmentHash,
  commitTxHash,
  originalData, // 会被加密保存
  accountAddress
);

console.log('任务创建成功，数据已加密保存');

// 6. 等待条件满足后，自动或手动揭示
// 当 task.status === 'ready_to_reveal' 时：

const revealTxHash = await twoPhaseCommitService.reveal(
  task.id,
  signerPrivateKey
  // 自动从加密数据中解密
);

console.log('数据已解密并发送到合约');
```

---

## 九、与 UI 集成

### 9.1 用户ID设置

在用户注册/登录时设置用户ID：

```typescript
// 在登录页面
const handleLogin = async (userId: string) => {
  const success = await stableThreeFeatureKey.initialize(userId);
  if (success) {
    // 登录成功，可以开始使用两阶段提交功能
  }
};
```

### 9.2 创建任务UI

```typescript
// 在创建任务页面
const handleCreateTask = async () => {
  // 1. 检查用户ID是否已设置
  const isValid = await stableThreeFeatureKey.validate();
  if (!isValid) {
    alert('请先设置用户ID');
    return;
  }

  // 2. 创建任务
  const task = await twoPhaseCommitService.createTask(
    chainId,
    contractAddress,
    commitmentHash,
    firstPhaseTxHash,
    originalData
  );

  alert('任务创建成功，数据已加密保存');
};
```

### 9.3 揭示数据UI

```typescript
// 在任务详情页面
const handleReveal = async () => {
  try {
    const txHash = await twoPhaseCommitService.reveal(
      taskId,
      signerPrivateKey
    );
    alert(`揭示成功，交易哈希: ${txHash}`);
  } catch (error) {
    if (error.message.includes('数据解密失败')) {
      // 提示用户输入原始数据
      const originalData = prompt('数据解密失败，请输入原始数据:');
      if (originalData) {
        const txHash = await twoPhaseCommitService.reveal(
          taskId,
          signerPrivateKey,
          originalData
        );
        alert(`揭示成功，交易哈希: ${txHash}`);
      }
    } else {
      alert(`揭示失败: ${error.message}`);
    }
  }
};
```

---

## 十、总结

### 核心特性

1. ✅ **三特征密钥系统**: 用户ID + 程序硬编码 + 操作系统特征
2. ✅ **自动加密/解密**: 承诺阶段自动加密，揭示阶段自动解密
3. ✅ **安全存储**: 使用 AES-256-GCM 加密，数据安全可靠
4. ✅ **易于使用**: 简单的 API，自动处理加密/解密

### 使用流程

1. 初始化密钥系统（设置用户ID）
2. 生成承诺哈希
3. 提交承诺到合约
4. 创建任务（自动加密数据）
5. 等待条件满足
6. 揭示数据（自动解密）

---

**文档版本**: 1.0
**最后更新**: 2024年

