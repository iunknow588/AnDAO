# AnDaoWallet H5 功能实现进度报告

## 文档信息
- **更新日期**: 2024年
- **状态**: 进行中
- **版本**: 1.0

---

## 一、已完成功能（P0 优先级）

### ✅ 1. MultiChainValidator 地址配置

**状态**: 已完成

**实现内容**:
- 在 `ChainConfig` 接口中添加了 `multiChainValidatorAddress` 字段
- 在所有链配置中添加了 MultiChainValidator 地址配置
- 更新了 `AccountManager` 从链配置中获取地址，而不是环境变量

**文件修改**:
- `src/types/index.ts`: 添加 `multiChainValidatorAddress` 字段
- `src/config/chains.ts`: 为所有链配置添加地址
- `src/services/AccountManager.ts`: 从链配置获取地址

**使用说明**:
```typescript
// 环境变量配置示例
VITE_MANTLE_MULTI_CHAIN_VALIDATOR_ADDRESS=0x...
VITE_MANTLE_TESTNET_MULTI_CHAIN_VALIDATOR_ADDRESS=0x...
```

---

### ✅ 2. 消息签名功能

**状态**: 已完成

**实现内容**:
- 创建了 `SignatureService` 服务类
- 实现了 `eth_sign` 签名（已弃用，但部分 DApp 仍在使用）
- 实现了 `personal_sign` 签名（EIP-191 标准，推荐）
- 实现了 `eth_signTypedData` 签名（EIP-712 标准，最安全）
- 实现了签名验证和地址恢复功能
- 更新了 `ProviderAdapter` 集成签名功能

**文件创建**:
- `src/services/SignatureService.ts`: 签名服务实现

**文件修改**:
- `src/adapters/ProviderAdapter.ts`: 集成签名功能

**功能说明**:
```typescript
// personal_sign 示例
const signature = await signatureService.personalSign('Hello, World!', privateKey);

// eth_signTypedData 示例
const typedData = {
  domain: { name: 'MyApp', version: '1', chainId: 1 },
  types: { Person: [{ name: 'name', type: 'string' }] },
  primaryType: 'Person',
  message: { name: 'Alice' }
};
const signature = await signatureService.signTypedData(typedData, privateKey);
```

**注意事项**:
- `eth_sign` 已弃用，存在安全风险，建议 DApp 使用 `personal_sign` 或 `eth_signTypedData`
- 当前实现中，获取私钥需要用户交互（输入密码），实际使用中应该通过 UI 实现

---

## 二、进行中功能（P1 优先级）

### 🔄 1. 守护人管理接口

**状态**: 部分完成（占位符实现）

**当前状态**:
- ✅ 基础框架已实现
- ⚠️ 使用占位符 ABI，需要根据实际插件合约接口实现
- ⚠️ Kernel 本身不包含守护人功能，需要通过插件实现

**待完成**:
1. 确定恢复插件的合约接口
2. 实现插件安装逻辑
3. 实现守护人添加/移除的插件调用
4. 实现从链上查询守护人列表

**文件**:
- `src/services/GuardianService.ts`

---

### ⏳ 2. 社交恢复功能

**状态**: 未开始

**依赖**:
- 需要先完成守护人管理接口
- 需要恢复插件合约

**待实现**:
1. 恢复请求发起
2. 守护人投票机制
3. 恢复完成逻辑
4. 恢复状态查询

---

### ⏳ 3. 两阶段提交合约接口

**状态**: 部分完成（占位符实现）

**当前状态**:
- ✅ 基础框架已实现
- ✅ 监控功能已实现（基于 setInterval）
- ⚠️ 合约接口使用占位符实现

**待完成**:
1. 确定两阶段提交合约的实际接口
2. 实现 `reveal` 方法的调用数据编码
3. 实现 `canReveal` 状态检查
4. 考虑 Service Worker 支持（后台监控）

**文件**:
- `src/services/TwoPhaseCommitService.ts`

---

## 三、待开始功能（P0-P2 优先级）

### ⏳ P0: 从 kernel-dev 导入合约类型和 ABI

**状态**: 待开始

**说明**:
- 需要先编译 kernel-dev 项目生成 artifacts
- 使用 TypeChain 生成 TypeScript 类型
- 从生成的类型和 ABI 导入，而不是本地定义

**步骤**:
1. 编译 kernel-dev: `cd kernel-dev && npm run compile`
2. 运行 TypeChain: `npm run typechain`
3. 更新导入语句使用生成的类型

**文件需要更新**:
- `src/utils/kernel.ts`
- `src/services/AccountManager.ts`
- `src/services/TransactionRelayer.ts`
- 其他使用合约 ABI 的文件

---

### ⏳ P2: 插件执行逻辑

**状态**: 未开始

**待实现**:
1. Executor 插件执行逻辑
2. Hook 插件执行逻辑
3. 插件执行上下文管理

**文件**:
- `src/services/PluginService.ts`

---

### ⏳ P2: 链管理功能

**状态**: 未开始

**待实现**:
1. `wallet_switchEthereumChain` 实现
2. `wallet_addEthereumChain` 实现
3. 链切换逻辑

**文件**:
- `src/adapters/ProviderAdapter.ts`

---

### ⏳ P2: Interaction Store

**状态**: 未开始

**说明**:
- 设计文档中提到但未实现
- 用于管理 DApp 请求队列

**待实现**:
1. 创建 InteractionStore
2. 实现请求队列管理
3. 实现权限管理
4. 集成到 ProviderAdapter

---

## 四、技术债务

### 1. 私钥获取机制

**问题**: 当前签名功能需要私钥，但获取私钥需要用户输入密码，没有实现 UI 交互

**解决方案**:
- 实现一个密码输入 UI 组件
- 或者实现会话密钥缓存机制（安全考虑）

### 2. 占位符实现

**问题**: 多个功能使用占位符实现，需要根据实际合约接口完善

**影响功能**:
- 守护人管理
- 两阶段提交
- 社交恢复

### 3. 错误处理

**问题**: 部分模块错误处理不够完善

**改进方向**:
- 统一错误类型
- 完善错误提示
- 添加错误恢复机制

---

## 五、下一步计划

### 短期（1-2周）

1. **完成 kernel-dev 类型导入**
   - 编译 kernel-dev
   - 运行 TypeChain
   - 更新所有导入语句

2. **完善守护人管理**
   - 确定恢复插件接口
   - 实现插件调用逻辑
   - 实现链上查询

3. **实现私钥获取 UI**
   - 创建密码输入组件
   - 集成到签名流程

### 中期（1个月）

1. **实现社交恢复功能**
2. **完善两阶段提交接口**
3. **实现链管理功能**

### 长期（2-3个月）

1. **实现插件执行逻辑**
2. **实现 Interaction Store**
3. **完善测试覆盖**

---

## 六、总结

### 已完成
- ✅ MultiChainValidator 地址配置
- ✅ 消息签名功能（eth_sign, personal_sign, eth_signTypedData）

### 进行中
- 🔄 守护人管理接口（占位符实现）
- 🔄 两阶段提交（部分实现）

### 待开始
- ⏳ kernel-dev 类型导入
- ⏳ 社交恢复功能
- ⏳ 插件执行逻辑
- ⏳ 链管理功能
- ⏳ Interaction Store

### 优先级建议

**立即处理**:
1. kernel-dev 类型导入（影响类型安全和代码维护）
2. 私钥获取 UI（影响用户体验）

**高优先级**:
1. 守护人管理接口完善
2. 社交恢复功能
3. 两阶段提交接口完善

**中优先级**:
1. 插件执行逻辑
2. 链管理功能
3. Interaction Store

---

**报告生成时间**: 2024年
**下次更新**: 待定

