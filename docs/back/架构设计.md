# AnDaoWallet HTML5 版本架构设计

## 文档信息

- **项目名称**: AnDaoWallet HTML5 版本
- **文档版本**: 1.0
- **编制日期**: 2024年
- **文档状态**: 正式版
- **对应文档**: 系统概述 v1.0

## 目录

1. [整体架构](#1-整体架构)
2. [分层架构设计](#2-分层架构设计)
3. [核心模块设计](#3-核心模块设计)
4. [状态管理架构](#4-状态管理架构)
5. [路由和导航设计](#5-路由和导航设计)
6. [数据流设计](#6-数据流设计)
7. [构建和打包策略](#7-构建和打包策略)
8. [性能优化设计](#8-性能优化设计)

---

## 1. 整体架构

### 1.1 架构概览

HTML5 版本采用**完全独立的分层模块化架构**，基于账户抽象（ERC-4337）和 Kernel 智能合约账户，不依赖任何传统钱包的核心代码。**完全无服务端，纯客户端实现**，所有数据存储在本地或链上。UI 层面参考 Keplr 的设计风格，但架构和代码完全独立。

```
┌─────────────────────────────────────────────────────────────┐
│                    Web 应用层 (HTML5)                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  UI 组件层 (React Components)                        │  │
│  │  - Pages, Layouts, Components                        │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Web 路由层 (React Router)                           │  │
│  │  - Route Management, Navigation                      │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Web 适配层 (Web Adapters)                           │  │
│  │  - Storage Adapter, Provider Adapter                 │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                        ↓ 依赖
┌─────────────────────────────────────────────────────────────┐
│              钱包核心层 (完全独立，基于账户抽象)              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 账户管理层 (AccountManager)                          │  │
│  │ - 基于 kernel-dev 的 Factory 接口                   │  │
│  │ - 智能合约账户创建和管理                              │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 交易中继层 (TransactionRelayer)                      │  │
│  │ - UserOperation 构造和签名                           │  │
│  │ - Bundler 客户端集成                                  │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 安全存储层 (SecurityVault)                            │  │
│  │ - 本地加密存储（IndexedDB）                          │  │
│  │ - 密钥管理                                            │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 链交互层 (Chain Adapters)                            │  │
│  │ - Mantle 链适配器（优先）                            │  │
│  │ - Injective 链适配器（待验证）                        │  │
│  │ - RPC 客户端（viem/ethers.js）                       │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ Kernel 合约层 (来自 kernel-dev)                       │  │
│  │ - Kernel 合约类型和接口                               │  │
│  │ - Factory 合约接口                                    │  │
│  │ - EntryPoint 合约接口                                 │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 架构特点

1. **完全独立**: 不依赖任何传统钱包的核心代码，完全基于账户抽象架构
2. **无服务端**: 纯客户端应用，不提供自建后端 API，所有业务逻辑在前端执行
3. **数据本地化**: 所有敏感数据存储在本地（IndexedDB 加密存储），不传输到任何服务器
4. **UI 参考**: 界面设计参考 Keplr 钱包，但代码完全独立实现
5. **直接集成**: 直接使用 kernel-dev 源码中的合约接口和类型定义
6. **分层清晰**: Web 应用层、钱包核心层、链交互层、合约层清晰分离
7. **模块化设计**: 功能模块独立，易于维护和扩展
8. **多链支持**: 优先支持 Mantle，Injective 支持待技术验证
9. **外部服务依赖**: 仅依赖链上 RPC、Bundler、Paymaster 等第三方服务

---

## 2. 分层架构设计

### 2.1 Web 应用层

#### 2.1.1 UI 组件层

**职责**: 提供用户界面组件和页面

**核心组件**:
- **Pages**: 页面级组件（钱包首页、交易页面、设置页面等）
- **Layouts**: 布局组件（主布局、弹窗布局等）
- **Components**: 可复用 UI 组件（按钮、输入框、卡片等）

**特点**:
- 基于 React 18
- 使用 Styled Components
- 响应式设计
- 与扩展版本共享组件库（适配后）

#### 2.1.2 Web 路由层

**职责**: 管理客户端路由和导航

**技术选型**: React Router v6+

**路由结构**:
```
/                          # 首页/钱包概览
/wallet                    # 钱包管理
  /create                  # 创建钱包
  /import                  # 导入钱包
  /unlock                  # 解锁钱包
/accounts                  # 账户管理
/chains                    # 链管理
/send                      # 发送交易
/sign                      # 签名页面
/two-phase-commit          # 两阶段提交管理
  /tasks                   # 任务列表
  /task/:id                # 任务详情
/settings                  # 设置页面
/dapp-connect              # DApp 连接管理
```

#### 2.1.3 Web 适配层

**职责**: 适配 Web 环境与扩展环境的差异

**核心适配器**:

1. **Storage Adapter**
   ```typescript
   interface StorageAdapter {
     get(key: string): Promise<any>;
     set(key: string, value: any): Promise<void>;
     remove(key: string): Promise<void>;
     clear(): Promise<void>;
   }
   ```
   - 扩展版本: `chrome.storage`
   - HTML5 版本: `IndexedDB` + `LocalStorage`

2. **Provider Adapter**
   ```typescript
   interface ProviderAdapter {
     // Window Provider for DApp integration
     registerProvider(): void;
     unregisterProvider(): void;
   }
   ```
   - 扩展版本: Extension Provider
   - HTML5 版本: Window Provider (window.keplr)

3. **Notification Adapter**
   ```typescript
   interface NotificationAdapter {
     show(message: string, options?: NotificationOptions): void;
   }
   ```
   - 扩展版本: Chrome Notifications API
   - HTML5 版本: Web Notifications API

### 2.2 核心功能层（共享）

核心功能层与扩展版本共享，包括：

- **状态管理层**: MobX Stores
- **业务逻辑层**: Services
- **多链支持层**: Chain Adapters
- **基础支撑层**: Crypto, Types, Common

详见扩展版本的架构文档。

---

## 3. 核心模块设计

### 3.1 存储模块

#### 3.1.1 存储架构

HTML5 版本使用 IndexedDB 作为主要存储，LocalStorage 用于轻量级配置。

```
Storage Layer
├── IndexedDB (主要存储)
│   ├── Vaults (加密钱包数据)
│   ├── Accounts (账户信息)
│   ├── Chains (链配置)
│   ├── Transactions (交易历史)
│   └── TwoPhaseCommitTasks (两阶段提交任务)
└── LocalStorage (配置存储)
    ├── Preferences (用户偏好)
    ├── Session (会话数据)
    └── Cache (缓存数据)
```

#### 3.1.2 存储适配器实现

```typescript
class IndexedDBStorageAdapter implements StorageAdapter {
  private db: IDBDatabase;
  
  async init(): Promise<void> {
    // 初始化 IndexedDB
  }
  
  async get(key: string): Promise<any> {
    // 从 IndexedDB 读取
  }
  
  async set(key: string, value: any): Promise<void> {
    // 写入 IndexedDB
  }
  
  async remove(key: string): Promise<void> {
    // 从 IndexedDB 删除
  }
}
```

### 3.2 Provider 模块

#### 3.2.1 Window Provider

HTML5 版本通过 `window.keplr` 对象提供 DApp 集成接口。

```typescript
interface Window {
  keplr?: Keplr;
}

// Provider 注册
class WindowProviderAdapter {
  registerProvider(): void {
    window.keplr = new KeplrWebProvider({
      // Web 环境配置
    });
  }
}
```

#### 3.2.2 DApp 通信机制

- **请求-响应模式**: 使用 `window.postMessage` 或直接调用
- **权限管理**: 基于 Origin 的权限控制
- **连接管理**: DApp 连接状态管理

### 3.3 两阶段提交模块（Web 适配）

#### 3.3.1 Web 环境限制

由于 Web 环境不支持后台运行，两阶段提交功能的实现需要特殊处理：

1. **页面保持打开**: 监控任务需要页面保持打开状态
2. **Service Worker（可选）**: 可以使用 Service Worker 在后台运行监控
3. **用户通知**: 当条件满足时，通过浏览器通知提醒用户

#### 3.3.2 实现策略

```typescript
class TwoPhaseCommitServiceWeb {
  private monitoringTasks: Map<string, MonitoringTask>;
  
  // 启动监控（需要页面打开）
  startMonitoring(taskId: string): void {
    // 使用 setInterval 或 requestAnimationFrame
    // 定期检查合约状态
  }
  
  // Service Worker 模式（可选）
  registerServiceWorker(): void {
    // 注册 Service Worker 进行后台监控
  }
}
```

### 3.4 硬件钱包模块

#### 3.4.1 WebUSB / WebHID 支持

HTML5 版本通过 WebUSB 和 WebHID API 支持硬件钱包。

```typescript
class HardwareWalletAdapterWeb {
  async connect(deviceType: 'ledger' | 'keystone'): Promise<Device> {
    if (deviceType === 'ledger') {
      // 使用 WebUSB 或 WebHID
      const device = await navigator.usb.requestDevice({...});
      return new LedgerDevice(device);
    }
  }
}
```

---

## 4. 状态管理架构

### 4.1 MobX Store 结构

HTML5 版本复用扩展版本的 MobX Store 结构，通过适配器连接存储层。

```
Store Layer (MobX)
├── KeyRingStore
│   └── 适配 → IndexedDBStorageAdapter
├── ChainStore
│   └── 适配 → IndexedDBStorageAdapter
├── InteractionStore
│   └── 适配 → SessionStorage
├── PermissionStore
│   └── 适配 → IndexedDBStorageAdapter
└── TwoPhaseCommitStore
    └── 适配 → IndexedDBStorageAdapter
```

### 4.2 Store 初始化

```typescript
class StoreInitializer {
  async initStores(): Promise<void> {
    // 1. 初始化存储适配器
    const storageAdapter = new IndexedDBStorageAdapter();
    await storageAdapter.init();
    
    // 2. 初始化 Stores
    const keyRingStore = new KeyRingStore(storageAdapter);
    const chainStore = new ChainStore(storageAdapter);
    // ...
    
    // 3. 连接 Store 到存储层
    keyRingStore.connect(storageAdapter);
    chainStore.connect(storageAdapter);
  }
}
```

---

## 5. 路由和导航设计

### 5.1 路由配置

```typescript
const routes = [
  {
    path: '/',
    element: <HomePage />,
  },
  {
    path: '/wallet',
    children: [
      { path: 'create', element: <CreateWalletPage /> },
      { path: 'import', element: <ImportWalletPage /> },
      { path: 'unlock', element: <UnlockWalletPage /> },
    ],
  },
  {
    path: '/two-phase-commit',
    children: [
      { path: 'tasks', element: <TaskListPage /> },
      { path: 'task/:id', element: <TaskDetailPage /> },
    ],
  },
  // ...
];
```

### 5.2 导航守卫

```typescript
function ProtectedRoute({ children }) {
  const keyRingStore = useKeyRingStore();
  
  if (!keyRingStore.isUnlocked) {
    return <Navigate to="/wallet/unlock" />;
  }
  
  return children;
}
```

### 5.3 路由懒加载

```typescript
const CreateWalletPage = lazy(() => import('./pages/wallet/CreateWalletPage'));
const ImportWalletPage = lazy(() => import('./pages/wallet/ImportWalletPage'));
```

---

## 6. 数据流设计

### 6.1 用户操作流程

```
User Action
  ↓
React Component
  ↓
MobX Store Action
  ↓
Service Layer
  ↓
Storage Adapter
  ↓
IndexedDB / LocalStorage
```

### 6.2 DApp 请求流程

```
DApp (window.keplr.request())
  ↓
Window Provider
  ↓
Provider Service
  ↓
Interaction Store (添加到队列)
  ↓
UI 显示确认对话框
  ↓
User Approval
  ↓
Service 执行操作
  ↓
返回结果给 DApp
```

### 6.3 两阶段提交流程（Web 版本）

```
User: submitTwoPhaseCommit()
  ↓
Store: 创建任务，保存到 IndexedDB
  ↓
Service: 启动监控（页面打开时）
  ↓
定时检查合约状态（setInterval / Service Worker）
  ↓
状态满足条件
  ↓
Browser Notification（可选）
  ↓
自动或手动执行 reveal
  ↓
更新任务状态
```

---

## 7. 构建和打包策略

### 7.1 构建工具选择

**选项 1: Webpack 5**（与扩展版本一致）
- 优点: 代码复用，配置一致
- 缺点: 构建速度较慢

**选项 2: Vite**（推荐）
- 优点: 开发体验好，构建速度快
- 缺点: 需要适配现有代码

### 7.2 代码分割策略

```javascript
// 路由级别的代码分割
const HomePage = lazy(() => import('./pages/HomePage'));
const WalletPage = lazy(() => import('./pages/WalletPage'));

// 功能模块级别的代码分割
const TwoPhaseCommitModule = lazy(() => import('./modules/TwoPhaseCommit'));
```

### 7.3 资源优化

- **代码压缩**: Terser / esbuild
- **CSS 优化**: 提取 CSS，压缩
- **图片优化**: 使用 WebP，懒加载
- **字体优化**: 子集化，预加载

### 7.4 输出结构

```
dist/
├── index.html
├── assets/
│   ├── index.[hash].js       # 主 bundle
│   ├── vendor.[hash].js      # 第三方库
│   ├── [route].[hash].js     # 路由代码块
│   └── [hash].css            # 样式文件
└── static/                   # 静态资源
    ├── fonts/
    └── images/
```

---

## 8. 性能优化设计

### 8.1 代码分割

- **路由级分割**: 每个路由独立 bundle
- **组件级分割**: 大型组件按需加载
- **第三方库分割**: Vendor bundle 单独打包

### 8.2 资源加载优化

- **预加载**: 关键资源预加载
- **预连接**: DNS 预解析，TCP 预连接
- **懒加载**: 图片和组件懒加载

### 8.3 缓存策略

- **静态资源**: 长期缓存（Content Hash）
- **HTML**: 短期缓存或禁用缓存
- **API 请求**: 适当的缓存策略

### 8.4 运行时优化

- **虚拟滚动**: 长列表使用虚拟滚动
- **防抖节流**: 用户输入防抖，滚动节流
- **Memo 优化**: React.memo, useMemo, useCallback

### 8.5 Service Worker（可选）

```typescript
// Service Worker 用于：
// 1. 离线支持
// 2. 后台监控（两阶段提交）
// 3. 资源缓存
```

---

## 总结

HTML5 版本的架构设计在保持与扩展版本核心功能一致的前提下，针对 Web 环境进行了适配和优化。通过适配器模式处理环境差异，最大化代码复用，同时为 Web 应用提供了良好的性能和用户体验。

架构设计遵循模块化、分层清晰的原则，便于维护和扩展。通过合理的代码分割、资源优化和缓存策略，确保 HTML5 版本在 Web 环境中能够提供流畅的用户体验。

