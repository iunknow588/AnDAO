# AnDaoWallet H5 系统概要设计说明书

## 文档信息

- **项目名称**：AnDaoWallet HTML5（`@andaowallet/h5`）
- **文档类型**：系统概要设计说明书（High-Level Design, HLD）
- **版本**：v0.1（重构）
- **最后更新**：2026-01-14
- **对应需求**：`docs/系统需求规格说明书.md`

## 文档目的与范围

本文档回答“系统**做什么**”的问题，描述系统的外部行为与整体设计框架，包括：

- 系统架构与分层
- 技术选型与关键约束
- 模块/子模块划分与职责边界
- 关键接口定义（模块对外接口/外部依赖接口）
- 数据流 / 控制流
- 关键数据模型（领域模型，关注外部可见结构）

> 模块内部实现细节、算法与具体数据结构，归入 `docs/系统详细设计.md`。

## 目录

1. [系统定位与边界](#1-系统定位与边界)
2. [总体架构](#2-总体架构)
3. [技术选型](#3-技术选型)
4. [模块与子模块划分](#4-模块与子模块划分)
5. [关键接口定义](#5-关键接口定义)
6. [数据流与控制流](#6-数据流与控制流)
7. [数据模型（领域模型）](#7-数据模型领域模型)
8. [部署与运行视图](#8-部署与运行视图)

---

## 1. 系统定位与边界

### 1.1 系统定位

AnDaoWallet H5 是一个**完全无服务端、纯前端**的智能合约钱包（Kernel / ERC-4337）。本系统提供钱包能力（账户创建、资产、交易、签名、DApp 连接），并提供“两阶段提交/比特承诺”的通用能力（支持第二阶段自动发送）。

### 1.2 系统边界

- **In Scope**：钱包 UI、AA 交互、Provider、基础资产/交易、赞助商机制（申请/审核/代付）、两阶段提交通用能力
- **Out of Scope**：NFT 业务本体（发行/流转/稀有度算法/UI）、自建后端、中心化账户体系

### 1.3 外部依赖

- **区块链 RPC**：链读取/写入
- **Bundler**：ERC-4337 userOp 发送
- **Paymaster（可选）**：Gas 代付策略
- **链上合约**：EntryPoint、Kernel、Factory、业务侧两阶段提交合约（外部项目提供）

---

## 2. 总体架构

### 2.1 分层架构

```
┌──────────────────────────────────────────────┐
│ UI/交互层（Pages/Components）                │
├──────────────────────────────────────────────┤
│ 应用编排层（路由/状态管理/会话）             │
├──────────────────────────────────────────────┤
│ 领域服务层（账户/交易/两阶段提交/赞助商等）  │
├──────────────────────────────────────────────┤
│ 适配器层（Provider/Storage/RPC/Bundler）      │
├──────────────────────────────────────────────┤
│ 外部依赖（链上合约、RPC、Bundler、Paymaster） │
└──────────────────────────────────────────────┘
```

### 2.2 关键设计约束（概要层）

- **无自建后端**：用户数据不落地到自有服务器
- **安全默认**：敏感数据本地加密存储；DApp 权限最小化
- **可用性**：外部服务不可用时需清晰提示与补救路径

---

## 3. 技术选型

- **前端框架**：React + Vite
- **状态管理**：MobX（或等价可替代方案，以代码实现为准）
- **账户抽象**：Kernel（ERC-4337）
- **链交互**：viem / ethers（以实现为准）
- **Provider 标准**：EIP-1193，支持 EIP-6963 钱包发现（如实现）
- **本地存储**：IndexedDB（持久化）+ LocalStorage（配置/标识）
- **本地加密**：Web Crypto API（AES-GCM），密码派生（PBKDF2 或实现中等价方案）

---

## 4. 模块与子模块划分

### 4.1 UI/交互层

- **欢迎与路径选择**：路径 A/B/C 入口与说明
- **账户创建流程页**：路径 A/B/C 分别的引导与确认
- **钱包主页**：资产、交易入口、DApp 连接入口
- **确认弹窗**：签名/交易/授权确认
- **设置**：自动锁定、网络、日志导出等

### 4.2 领域服务层（对外行为）

- **AccountService/AccountManager**：账户预测、创建、导入、切换
- **TransactionRelayer**：userOp 构造、签名、发送、回执查询
- **TwoPhaseCommitService**：两阶段提交任务创建、状态管理、第二阶段自动发送
- **SponsorService**：赞助商注册、申请创建、审核、代付部署
- **AuthService**：解锁/会话/自动锁定
- **SettingsService**：配置管理

### 4.3 适配器层

- **ProviderAdapter**：对 DApp 提供 EIP-1193 接口与事件
- **StorageAdapter**：本地持久化与加密封装
- **RPC/BundlerClient**：网络与外部服务调用封装（含失败重试/故障转移策略的抽象）

---

## 5. 关键接口定义

> 只列出“模块对外可见”的接口形态；参数/错误码细节在详细设计中展开。

### 5.1 Provider（对 DApp）

- `ethereum.request({ method, params })`
- 事件：`accountsChanged`、`chainChanged`（按实现支持）

### 5.2 两阶段提交（对业务/插件/页面）

- `createTask(...)`：创建两阶段任务（包含第一阶段交易与本地加密保存）
- `revealAuto(...)`：在条件满足时自动发送第二阶段（无需二次签名）
- `revealManual(...)`：人工触发/补救路径（可选）

### 5.3 赞助商申请（对路径 A/C）

- `createApplication(...)`
- `reviewApplication(...)`
- `deployAccountForUser(...)`

---

## 6. 数据流与控制流

### 6.1 两阶段提交（通用）控制流

```
用户输入原始数据
  ↓
生成 commitment
  ↓
发送第一阶段交易（userOp）
  ↓
本地加密保存任务数据（用于第二阶段）
  ↓
等待条件满足（时间/链上状态/业务回调）
  ↓
自动发送第二阶段交易（无需二次签名）
  ↓
成功/失败 → 状态更新与可重试/补救
```

### 6.2 三路径创建（概要数据流）

#### 6.2.1 路径 A（极简体验 / 申请制）

```
用户选择路径A
  ↓
本地生成智能账户控制密钥并加密保存
  ↓
预测智能账户地址
  ↓
选择赞助商（列表/邀请码）
  ↓
创建申请（申请详情可写入可插拔存储；链上索引记录标识符与状态）
  ↓
用户侧查询/轮询申请状态
  ↓
赞助商审核通过并代付部署
  ↓
状态更新（链上/存储/本地）
  ↓
进入钱包主界面
```

#### 6.2.2 路径 B（标准模式 / 自付或申请赞助）

```
用户选择路径B
  ↓
创建/导入 EOA（可选）
  ↓
本地生成智能账户控制密钥并加密保存
  ↓
选择 Gas 支付方式：
  ├─ 自付：EOA 发送部署交易 / 或 AA 部署路径
  └─ 赞助：走路径A的“申请/审核/代付部署”链路
  ↓
进入钱包主界面（可切换 EOA / 智能账户视图）
```

#### 6.2.3 路径 C（赞助商注册 / 审核与代付）

```
用户选择路径C
  ↓
配置赞助商资料与 Gas 支付账户
  ↓
配置审核规则（限额/频率/渠道等）
  ↓
完成注册（链上/本地）
  ↓
进入赞助商视图
  ↓
读取申请 → 审核 → 代付部署 → 更新状态
```

#### 6.2.4 两阶段提交（比特承诺）通用能力

```
用户提交第一阶段（commit）
  ↓
本地加密保存第二阶段所需任务数据
  ↓
条件满足后自动发送第二阶段（无需二次签名）
  ↓
失败可重试/可手动补救
```

---

## 7. 数据模型（领域模型）

> 本节给出“外部可见”的领域模型字段（做什么/对外行为视角）。具体持久化结构与内部字段扩展见详细设计。

### 7.1 枚举与标识

- **UserType**：`simple` / `standard` / `sponsor`
- **AccountCreationPath**：`path_a_simple` / `path_b_standard` / `path_c_sponsor`
- **AccountStatus**：`predicted` / `pending` / `deployed` / `rejected`

### 7.2 Account（账户）

| 字段 | 含义 |
|------|------|
| address | 智能合约账户地址 |
| chainId | 链 ID |
| owner | 控制密钥地址（签名者） |
| eoaAddress? | 路径 B/C 可能存在的 EOA 地址 |
| userType | 用户类型 |
| creationPath | 创建路径 |
| status | 账户状态 |
| createdAt | 创建时间 |
| deployedAt? | 部署时间（可选） |
| sponsorId? | 赞助商 ID（路径 A） |

### 7.3 Sponsor（赞助商）

| 字段 | 含义 |
|------|------|
| id | 赞助商标识 |
| address | 赞助商链上地址 |
| name | 展示名称 |
| rules? | 审核/限额规则（概要层只定义存在性） |

### 7.4 Application（申请）

| 字段 | 含义 |
|------|------|
| id | 申请 ID |
| accountAddress | 目标智能账户地址（预测或已部署） |
| ownerAddress | 控制密钥地址 |
| sponsorId | 赞助商 ID |
| chainId | 链 ID |
| status | `pending/approved/rejected/deployed` |
| storageIdentifier? | 存储标识符（CID/URI 等） |
| storageType? | 存储类型（ipfs/custom/...） |

### 7.5 TwoPhaseTask（两阶段任务）

| 字段 | 含义 |
|------|------|
| id | 任务 ID |
| chainId | 链 ID |
| contractAddress | 业务合约地址（外部项目） |
| commitment | 第一阶段承诺值 |
| createdAt | 创建时间 |
| status | `committed/reveal_pending/revealed/failed`（示意） |

---

## 8. 部署与运行视图

- **静态部署**：构建产物为纯静态资源，部署到 CDN/静态托管（Vercel/Nginx/OSS）
- **运行依赖**：浏览器环境 + 外部 RPC/Bundler/Paymaster
