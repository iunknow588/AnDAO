# AnDaoWallet H5 åŠŸèƒ½å®ç°å®Œæˆæ€»ç»“

## æ–‡æ¡£ä¿¡æ¯
- **å®Œæˆæ—¥æœŸ**: 2024å¹´
- **çŠ¶æ€**: ä¸»è¦åŠŸèƒ½å·²å®Œæˆ
- **ç‰ˆæœ¬**: 1.1

---

## ä¸€ã€å·²å®ŒæˆåŠŸèƒ½æ¸…å•

### âœ… P0 ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰

#### 1. MultiChainValidator åœ°å€é…ç½® âœ…
- **çŠ¶æ€**: å·²å®Œæˆ
- **å®ç°å†…å®¹**:
  - åœ¨ `ChainConfig` æ¥å£ä¸­æ·»åŠ äº† `multiChainValidatorAddress` å­—æ®µ
  - æ›´æ–°äº†æ‰€æœ‰é“¾é…ç½®ï¼ˆMantleã€Mantle Testnetã€Injectiveï¼‰
  - ä¿®æ”¹äº† `AccountManager` ä»é“¾é…ç½®è·å–åœ°å€
- **æ–‡ä»¶**:
  - `src/types/index.ts`
  - `src/config/chains.ts`
  - `src/services/AccountManager.ts`

#### 2. æ¶ˆæ¯ç­¾ååŠŸèƒ½ âœ…
- **çŠ¶æ€**: å·²å®Œæˆ
- **å®ç°å†…å®¹**:
  - åˆ›å»ºäº† `SignatureService` æœåŠ¡ç±»
  - å®ç°äº† `eth_sign`ã€`personal_sign`ã€`eth_signTypedData`
  - å®ç°äº†ç­¾åéªŒè¯å’Œåœ°å€æ¢å¤
  - æ›´æ–°äº† `ProviderAdapter` é›†æˆç­¾ååŠŸèƒ½
- **æ–‡ä»¶**:
  - `src/services/SignatureService.ts` (æ–°å»º)
  - `src/adapters/ProviderAdapter.ts`

---

### âœ… P1 ä¼˜å…ˆçº§ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### 1. å®ˆæŠ¤äººç®¡ç†æ¥å£ âœ…
- **çŠ¶æ€**: æ¡†æ¶å®Œæˆï¼ˆåŸºäºæ’ä»¶å®ç°ï¼‰
- **å®ç°å†…å®¹**:
  - æ›´æ–°äº†æ³¨é‡Šï¼Œè¯´æ˜éœ€è¦é€šè¿‡æ’ä»¶å®ç°
  - ä¿ç•™äº†å ä½ç¬¦å®ç°ï¼Œç­‰å¾…å®é™…æ’ä»¶æ¥å£
  - å®ç°äº†æœ¬åœ°å­˜å‚¨ç®¡ç†
- **æ–‡ä»¶**:
  - `src/services/GuardianService.ts`

#### 2. ç¤¾äº¤æ¢å¤åŠŸèƒ½ âœ…
- **çŠ¶æ€**: å·²å®Œæˆï¼ˆåŸºäºæ’ä»¶å®ç°ï¼‰
- **å®ç°å†…å®¹**:
  - å®ç°äº† `initiateRecovery` æ–¹æ³•
  - å®ç°äº† `voteForRecovery` æ–¹æ³•
  - å®ç°äº†æ¢å¤è¯·æ±‚çš„æœ¬åœ°å­˜å‚¨ç®¡ç†
  - å®ç°äº†æ¢å¤è¯·æ±‚æŸ¥è¯¢åŠŸèƒ½
- **è¯´æ˜**:
  - åŸºäºæ¢å¤æ’ä»¶å®ç°ï¼Œéœ€è¦å…ˆå®‰è£…æ¢å¤æ’ä»¶
  - æ”¯æŒå®ˆæŠ¤äººæŠ•ç¥¨æœºåˆ¶
  - å½“è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œæ¢å¤æ’ä»¶è‡ªåŠ¨æ‰§è¡Œæ¢å¤
- **æ–‡ä»¶**:
  - `src/services/GuardianService.ts`

#### 3. ä¸¤é˜¶æ®µæäº¤åˆçº¦æ¥å£ âœ…
- **çŠ¶æ€**: å·²å®Œæˆ
- **å®ç°å†…å®¹**:
  - å®ç°äº†æ ‡å‡†ä¸¤é˜¶æ®µæäº¤åˆçº¦ ABI
  - å®ç°äº† `canReveal` çŠ¶æ€æ£€æŸ¥ï¼ˆæ”¯æŒé™çº§æ–¹æ¡ˆï¼‰
  - å®ç°äº† `reveal` è°ƒç”¨æ•°æ®ç¼–ç 
  - å®Œå–„äº†ä»»åŠ¡ç®¡ç†ï¼ˆæ·»åŠ è´¦æˆ·åœ°å€å­—æ®µï¼‰
  - æ”¹è¿›äº†è´¦æˆ·åœ°å€è·å–é€»è¾‘
- **æ ‡å‡†æ¥å£**:
  ```solidity
  - commit(bytes32 commitmentHash, bytes calldata defaultValue)
  - reveal(bytes calldata originalData)
  - canReveal(bytes32 commitmentHash) view returns (bool)
  - getCommitmentStatus(bytes32 commitmentHash) view returns (...)
  ```
- **æ–‡ä»¶**:
  - `src/services/TwoPhaseCommitService.ts`
  - `src/types/index.ts`

---

## äºŒã€å¾…å®ŒæˆåŠŸèƒ½

### â³ P0 ä¼˜å…ˆçº§

#### 1. ä» kernel-dev å¯¼å…¥åˆçº¦ç±»å‹å’Œ ABI
- **çŠ¶æ€**: å¾…å¼€å§‹
- **è¯´æ˜**: éœ€è¦å…ˆç¼–è¯‘ kernel-dev é¡¹ç›®
- **æ­¥éª¤**:
  1. ç¼–è¯‘ kernel-dev: `cd kernel-dev && npm run compile`
  2. è¿è¡Œ TypeChain: `npm run typechain`
  3. æ›´æ–°å¯¼å…¥è¯­å¥ä½¿ç”¨ç”Ÿæˆçš„ç±»å‹

---

### â³ P2 ä¼˜å…ˆçº§ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 1. æ’ä»¶æ‰§è¡Œé€»è¾‘
- **çŠ¶æ€**: æœªå¼€å§‹
- **å¾…å®ç°**:
  - Executor æ’ä»¶æ‰§è¡Œé€»è¾‘
  - Hook æ’ä»¶æ‰§è¡Œé€»è¾‘

#### 2. é“¾ç®¡ç†åŠŸèƒ½
- **çŠ¶æ€**: æœªå¼€å§‹
- **å¾…å®ç°**:
  - `wallet_switchEthereumChain`
  - `wallet_addEthereumChain`

#### 3. Interaction Store
- **çŠ¶æ€**: æœªå¼€å§‹
- **è¯´æ˜**: ç”¨äºç®¡ç† DApp è¯·æ±‚é˜Ÿåˆ—

---

## ä¸‰ã€æŠ€æœ¯æ”¹è¿›

### 1. ä»£ç æ³¨é‡Šå¢å¼º âœ…
- ä¸ºæ‰€æœ‰å…³é”®æ¨¡å—æ·»åŠ äº†è¯¦ç»†æ³¨é‡Š
- æ·»åŠ äº†ä½¿ç”¨ç¤ºä¾‹å’Œè¯´æ˜
- æ ‡æ³¨äº† TODO å’Œæ”¹è¿›å»ºè®®

### 2. ç±»å‹å®šä¹‰å®Œå–„ âœ…
- æ·»åŠ äº† `accountAddress` å­—æ®µåˆ° `TwoPhaseCommitTask`
- æ·»åŠ äº† `multiChainValidatorAddress` å­—æ®µåˆ° `ChainConfig`
- å®Œå–„äº†æ¥å£æ–‡æ¡£æ³¨é‡Š

### 3. é”™è¯¯å¤„ç†æ”¹è¿› âœ…
- æ”¹è¿›äº†é”™è¯¯æç¤ºä¿¡æ¯
- æ·»åŠ äº†é™çº§æ–¹æ¡ˆï¼ˆå¦‚ `canReveal` æ£€æŸ¥ï¼‰

---

## å››ã€å®ç°ç»†èŠ‚

### 1. ä¸¤é˜¶æ®µæäº¤å®ç°

**æ ‡å‡†æ¥å£**:
```typescript
// æ ‡å‡† ABI å·²å®šä¹‰
const TWO_PHASE_COMMIT_ABI = [
  { name: 'commit', inputs: ['bytes32', 'bytes'], ... },
  { name: 'reveal', inputs: ['bytes'], ... },
  { name: 'canReveal', inputs: ['bytes32'], outputs: ['bool'], ... },
  { name: 'getCommitmentStatus', inputs: ['bytes32'], ... },
];
```

**çŠ¶æ€æ£€æŸ¥**:
- ä¼˜å…ˆä½¿ç”¨ `canReveal` æ–¹æ³•
- é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ `getCommitmentStatus` æ£€æŸ¥çŠ¶æ€

**è´¦æˆ·åœ°å€ç®¡ç†**:
- ä»»åŠ¡ä¸­ä¿å­˜è´¦æˆ·åœ°å€
- æ”¯æŒä» AccountManager è‡ªåŠ¨è·å–

### 2. ç¤¾äº¤æ¢å¤å®ç°

**åŸºäºæ’ä»¶æ¶æ„**:
- æ¢å¤åŠŸèƒ½é€šè¿‡æ¢å¤æ’ä»¶å®ç°
- æ”¯æŒæ ‡å‡†çš„æ¢å¤æ’ä»¶æ¥å£

**æ¢å¤æµç¨‹**:
1. è°ƒç”¨æ¢å¤æ’ä»¶çš„ `initiateRecovery` æ–¹æ³•
2. æ¢å¤æ’ä»¶åˆ›å»ºæ¢å¤è¯·æ±‚
3. å®ˆæŠ¤äººé€šè¿‡ `voteForRecovery` æŠ•ç¥¨
4. è¾¾åˆ°é˜ˆå€¼åï¼Œæ¢å¤æ’ä»¶è‡ªåŠ¨æ‰§è¡Œæ¢å¤

**æœ¬åœ°å­˜å‚¨**:
- æ¢å¤è¯·æ±‚ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
- æ”¯æŒæŸ¥è¯¢æ¢å¤è¯·æ±‚åˆ—è¡¨

### 3. æ¶ˆæ¯ç­¾åå®ç°

**æ”¯æŒçš„æ ‡å‡†**:
- `eth_sign`: åŸå§‹æ¶ˆæ¯ç­¾åï¼ˆå·²å¼ƒç”¨ï¼‰
- `personal_sign`: EIP-191 æ ‡å‡†ï¼ˆæ¨èï¼‰
- `eth_signTypedData`: EIP-712 æ ‡å‡†ï¼ˆæœ€å®‰å…¨ï¼‰

**å®ç°æ–¹å¼**:
- ä½¿ç”¨ viem å’Œ ethers.js è¿›è¡Œç­¾å
- æ”¯æŒç­¾åéªŒè¯å’Œåœ°å€æ¢å¤

---

## äº”ã€ä½¿ç”¨ç¤ºä¾‹

### 1. ä¸¤é˜¶æ®µæäº¤

```typescript
// åˆ›å»ºä»»åŠ¡
const task = await twoPhaseCommitService.createTask(
  chainId,
  contractAddress,
  commitmentHash,
  firstPhaseTxHash,
  accountAddress // å¯é€‰
);

// æ£€æŸ¥æ˜¯å¦å¯ä»¥æ­ç¤º
const canReveal = await twoPhaseCommitService.checkCanReveal(task);

// æ­ç¤ºæ•°æ®
if (canReveal) {
  const txHash = await twoPhaseCommitService.reveal(
    task.id,
    originalData,
    signerPrivateKey
  );
}
```

### 2. ç¤¾äº¤æ¢å¤

```typescript
// å‘èµ·æ¢å¤è¯·æ±‚
const { recoveryId, txHash } = await guardianService.initiateRecovery(
  accountAddress,
  chainId,
  newOwnerAddress,
  recoveryPluginAddress,
  signerPrivateKey
);

// å®ˆæŠ¤äººæŠ•ç¥¨
const voteTxHash = await guardianService.voteForRecovery(
  accountAddress,
  chainId,
  recoveryId,
  recoveryPluginAddress,
  guardianPrivateKey
);
```

### 3. æ¶ˆæ¯ç­¾å

```typescript
// personal_sign
const signature = await signatureService.personalSign(
  'Hello, World!',
  privateKey
);

// eth_signTypedData
const typedData = {
  domain: { name: 'MyApp', version: '1', chainId: 1 },
  types: { Person: [{ name: 'name', type: 'string' }] },
  primaryType: 'Person',
  message: { name: 'Alice' }
};
const signature = await signatureService.signTypedData(
  typedData,
  privateKey
);
```

---

## å…­ã€æ³¨æ„äº‹é¡¹

### 1. æ’ä»¶ä¾èµ–

- **å®ˆæŠ¤äººç®¡ç†**: éœ€è¦é€šè¿‡å®ˆæŠ¤äººç®¡ç†æ’ä»¶å®ç°
- **ç¤¾äº¤æ¢å¤**: éœ€è¦é€šè¿‡æ¢å¤æ’ä»¶å®ç°
- **ä¸¤é˜¶æ®µæäº¤**: éœ€è¦åˆçº¦å®ç°æ ‡å‡†æ¥å£

### 2. é…ç½®è¦æ±‚

- **MultiChainValidator åœ°å€**: å¿…é¡»åœ¨é“¾é…ç½®ä¸­è®¾ç½®
- **æ¢å¤æ’ä»¶åœ°å€**: éœ€è¦åœ¨è°ƒç”¨æ—¶æä¾›æˆ–é…ç½®
- **åˆçº¦åœ°å€**: ä¸¤é˜¶æ®µæäº¤éœ€è¦åˆçº¦åœ°å€

### 3. ç§é’¥ç®¡ç†

- å½“å‰å®ç°éœ€è¦ç”¨æˆ·è¾“å…¥å¯†ç è·å–ç§é’¥
- å»ºè®®å®ç°ä¼šè¯å¯†é’¥ç¼“å­˜æœºåˆ¶
- å»ºè®®å®ç°å¯†ç è¾“å…¥ UI ç»„ä»¶

---

## ä¸ƒã€ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. **å®Œæˆ kernel-dev ç±»å‹å¯¼å…¥**
   - ç¼–è¯‘ kernel-dev
   - è¿è¡Œ TypeChain
   - æ›´æ–°æ‰€æœ‰å¯¼å…¥è¯­å¥

2. **å®ç°ç§é’¥è·å– UI**
   - åˆ›å»ºå¯†ç è¾“å…¥ç»„ä»¶
   - é›†æˆåˆ°ç­¾åæµç¨‹

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰

1. **å®Œå–„æ’ä»¶ç³»ç»Ÿ**
   - å®ç°æ’ä»¶æ‰§è¡Œé€»è¾‘
   - å®Œå–„æ’ä»¶ç®¡ç†

2. **å®ç°é“¾ç®¡ç†åŠŸèƒ½**
   - `wallet_switchEthereumChain`
   - `wallet_addEthereumChain`

3. **å®ç° Interaction Store**
   - ç®¡ç† DApp è¯·æ±‚é˜Ÿåˆ—
   - å®ç°æƒé™ç®¡ç†

---

## å…«ã€æ€»ç»“

### å·²å®Œæˆ âœ…
- âœ… MultiChainValidator åœ°å€é…ç½®
- âœ… æ¶ˆæ¯ç­¾ååŠŸèƒ½ï¼ˆeth_sign, personal_sign, eth_signTypedDataï¼‰
- âœ… å®ˆæŠ¤äººç®¡ç†æ¥å£ï¼ˆæ¡†æ¶ï¼‰
- âœ… ç¤¾äº¤æ¢å¤åŠŸèƒ½ï¼ˆåŸºäºæ’ä»¶ï¼‰
- âœ… ä¸¤é˜¶æ®µæäº¤åˆçº¦æ¥å£ï¼ˆæ ‡å‡†å®ç°ï¼‰

### è¿›è¡Œä¸­ ğŸ”„
- ğŸ”„ kernel-dev ç±»å‹å¯¼å…¥ï¼ˆéœ€è¦ç¼–è¯‘ï¼‰

### å¾…å¼€å§‹ â³
- â³ æ’ä»¶æ‰§è¡Œé€»è¾‘
- â³ é“¾ç®¡ç†åŠŸèƒ½
- â³ Interaction Store

### ä»£ç è´¨é‡ âœ…
- âœ… è¯¦ç»†æ³¨é‡Š
- âœ… ç±»å‹å®‰å…¨
- âœ… é”™è¯¯å¤„ç†
- âœ… é™çº§æ–¹æ¡ˆ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2024å¹´
**å®Œæˆåº¦**: çº¦ 80%ï¼ˆä¸»è¦åŠŸèƒ½å·²å®Œæˆï¼‰

