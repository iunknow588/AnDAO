# AnDaoWallet HTML5 版本部署指南

## 文档信息

- **项目名称**: AnDaoWallet HTML5 版本
- **文档版本**: 1.0
- **编制日期**: 2024年
- **文档状态**: 正式版

## 目录

1. [构建配置](#1-构建配置)
2. [静态托管与 CDN](#2-静态托管与-cdn)
3. [性能优化](#3-性能优化)
4. [安全配置](#4-安全配置)
5. [监控和日志](#5-监控和日志)
6. [部署流程](#6-部署流程)

---

## 1. 构建配置

### 1.1 环境变量

创建 `.env.production` 文件：

```bash
# 链配置（Mantle 优先）
VITE_MANTLE_RPC_URL=https://rpc.mantle.xyz
VITE_MANTLE_BUNDLER_URL=https://bundler.mantle.xyz
VITE_MANTLE_KERNEL_FACTORY_ADDRESS=0x...
VITE_MANTLE_ENTRYPOINT_ADDRESS=0x...
VITE_MANTLE_MULTI_CHAIN_VALIDATOR_ADDRESS=0x...

# Injective 配置（可选，待技术验证）
VITE_INJECTIVE_RPC_URL=https://rpc.injective.network
VITE_INJECTIVE_BUNDLER_URL=https://bundler.injective.network
VITE_INJECTIVE_KERNEL_FACTORY_ADDRESS=0x...
VITE_INJECTIVE_ENTRYPOINT_ADDRESS=0x...

# 功能开关
VITE_ENABLE_ANALYTICS=false
VITE_ENABLE_SENTRY=false

# Sentry 配置（如果使用）
VITE_SENTRY_DSN=https://xxx@sentry.io/xxx

# 其他配置
VITE_APP_VERSION=0.1.0
VITE_BUILD_TIME=2024-01-01T00:00:00Z
```

**注意**: 使用 Vite 时，环境变量必须以 `VITE_` 开头。

### 1.2 生产构建

```bash
# 安装依赖
npm install

# 类型检查
npm run type-check

# 构建生产版本
npm run build

# 构建输出目录
# dist/
```

### 1.3 构建优化

#### 1.3.1 代码分割（Vite 配置）

```typescript
// vite.config.ts
export default {
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'mobx-vendor': ['mobx', 'mobx-react-lite'],
          'viem-vendor': ['viem'],
          'ethers-vendor': ['ethers'],
        },
      },
    },
  },
};
```

**实际配置**: 已在 `vite.config.ts` 中配置代码分割。

#### 1.3.2 资源压缩（Vite 自动处理）

Vite 在生产构建时自动压缩资源：

- **JavaScript**: Terser（已在 vite.config.ts 中配置）
- **CSS**: 自动压缩
- **HTML**: 自动压缩
- **图片**: 使用 WebP 格式，压缩优化（需要手动处理）

**实际配置**:
```typescript
// vite.config.ts
build: {
  minify: 'terser',
  terserOptions: {
    compress: {
      drop_console: true,  // 生产环境移除 console
      drop_debugger: true,
    },
  },
  cssCodeSplit: true,  // CSS 代码分割
}
```

#### 1.3.3 Tree Shaking

Vite 默认启用 Tree Shaking，确保使用 ES 模块：

```json
// package.json
{
  "type": "module",  // 已配置
  "sideEffects": false  // 可选，如果所有代码都是纯函数
}
```

#### 1.3.4 PWA 配置

PWA 功能已通过 `vite-plugin-pwa` 配置：

- ✅ Service Worker 自动生成
- ✅ Manifest 配置（public/manifest.json）
- ✅ 离线支持（Workbox）
- ✅ 自动更新机制

**配置位置**: `vite.config.ts` 中的 `VitePWA` 插件配置

---

## 2. 静态托管与 CDN

> **原则**：本产品为纯前端 PWA，无自建后端。将 `dist/` 作为静态资源托管（Nginx/Apache/OSS/静态站点/CDN 任一均可）。如需反向代理，仅用于静态文件与链上 RPC/Bundler 透传，不落地任何用户数据。

### 2.1 Nginx 配置（纯静态）

```nginx
server {
    listen 443 ssl http2;
    server_name wallet.example.com;
    
    # SSL 证书配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # 根目录（Vite 构建输出）
    root /var/www/wallet/dist;
    index index.html;
    
    # PWA 支持（Service Worker）
    location /sw.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # Manifest 文件
    location /manifest.webmanifest {
        add_header Content-Type "application/manifest+json";
        expires 1d;
    }
    
    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/manifest+json;
    gzip_min_length 1000;
    
    # 静态资源缓存（带 Content Hash 的资源）
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # HTML 文件不缓存
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 安全头（仅静态资源）
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-ancestors 'self';" always;
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }
}
```

### 2.2 Apache 配置（纯静态）

```apache
<VirtualHost *:443>
    ServerName wallet.example.com
    
    DocumentRoot /var/www/wallet/dist
    
    # SSL 配置
    SSLEngine on
    SSLCertificateFile /path/to/cert.pem
    SSLCertificateKeyFile /path/to/key.pem
    
    # Gzip 压缩
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
    </IfModule>
    
    # 静态资源缓存
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
    </IfModule>
    
    # SPA 路由支持
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </IfModule>
    
    # 安全头
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set X-XSS-Protection "1; mode=block"
</VirtualHost>
```

### 2.3 其他静态托管选项
- 对象存储 + CDN：例如 Cloudflare Pages / Vercel / Netlify / OSS + CDN，直接上传 `dist/`。
- 不建议使用自建 Node/Express 作为中间层（无服务端逻辑需求）。

---

## 3. CDN 配置

### 3.1 使用 CDN

将静态资源托管到 CDN，加速资源加载：

```html
<!-- 在 index.html 中引用 CDN 资源 -->
<script src="https://cdn.example.com/js/vendor.js"></script>
<link rel="stylesheet" href="https://cdn.example.com/css/main.css">
```

### 3.2 CDN 缓存策略

- **静态资源**: 长期缓存（1年），使用 Content Hash
- **HTML 文件**: 短期缓存或不缓存
- **API 响应**: 根据数据特性设置缓存

### 3.3 CDN 配置示例（Cloudflare）

1. **页面规则**:
   - `*.html`: 缓存级别 "Bypass"
   - `*.js`: 缓存级别 "Standard"，边缘缓存 TTL "1 year"
   - `*.css`: 缓存级别 "Standard"，边缘缓存 TTL "1 year"

2. **压缩**:
   - 启用 Auto Minify (JavaScript, CSS, HTML)
   - 启用 Brotli 压缩

3. **安全**:
   - 启用 HTTPS
   - 启用 WAF (Web Application Firewall)

---

## 4. 性能优化

### 4.1 资源优化

#### 4.1.1 图片优化

- 使用 WebP 格式
- 使用响应式图片 (`srcset`)
- 图片懒加载
- 使用适当的图片尺寸

#### 4.1.2 字体优化

- 字体子集化
- 使用 `font-display: swap`
- 预加载关键字体

```html
<link rel="preload" href="/fonts/main.woff2" as="font" type="font/woff2" crossorigin>
```

#### 4.1.3 代码优化

- 代码分割和懒加载
- Tree Shaking
- 移除未使用的代码
- 使用 production mode 构建

### 4.2 加载优化

#### 4.2.1 预加载关键资源

```html
<link rel="preload" href="/js/main.js" as="script">
<link rel="preload" href="/css/main.css" as="style">
```

#### 4.2.2 DNS 预解析

```html
<link rel="dns-prefetch" href="https://api.example.com">
<link rel="dns-prefetch" href="https://rpc.example.com">
```

#### 4.2.3 预连接

```html
<link rel="preconnect" href="https://api.example.com">
```

### 4.3 运行时优化

- 使用 Service Worker 缓存
- 虚拟滚动（长列表）
- 防抖和节流
- Memo 优化（React.memo, useMemo, useCallback）

---

## 5. 安全配置

### 5.1 HTTPS

- 使用有效的 SSL/TLS 证书
- 强制 HTTPS 重定向
- 使用 HSTS (HTTP Strict Transport Security)

```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

### 5.2 Content Security Policy (CSP)

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-ancestors 'self';" always;
```

### 5.3 安全头

```nginx
# X-Frame-Options: 防止点击劫持
add_header X-Frame-Options "SAMEORIGIN" always;

# X-Content-Type-Options: 防止 MIME 类型嗅探
add_header X-Content-Type-Options "nosniff" always;

# X-XSS-Protection: XSS 保护
add_header X-XSS-Protection "1; mode=block" always;

# Referrer-Policy: 控制 referrer 信息
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
```

### 5.4 密钥安全

- 密钥仅在客户端存储（IndexedDB）
- 使用加密存储
- 不传输密钥到服务器
- 支持硬件钱包

---

## 6. 监控和日志

### 6.1 错误监控

#### 6.1.1 Sentry 集成

```typescript
import * as Sentry from '@sentry/react';

Sentry.init({
  dsn: process.env.REACT_APP_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  release: process.env.REACT_APP_VERSION,
  tracesSampleRate: 1.0,
});
```

#### 6.1.2 错误边界

```typescript
import { ErrorBoundary } from '@sentry/react';

function App() {
  return (
    <ErrorBoundary fallback={<ErrorFallback />}>
      <Router>
        {/* ... */}
      </Router>
    </ErrorBoundary>
  );
}
```

### 6.2 性能监控

#### 6.2.1 Web Vitals

```typescript
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

function sendToAnalytics(metric) {
  // 发送到分析服务
  console.log(metric);
}

getCLS(sendToAnalytics);
getFID(sendToAnalytics);
getFCP(sendToAnalytics);
getLCP(sendToAnalytics);
getTTFB(sendToAnalytics);
```

### 6.3 访问日志

配置服务器访问日志：

```nginx
access_log /var/log/nginx/wallet-access.log;
error_log /var/log/nginx/wallet-error.log;
```

### 6.4 分析工具

- **Google Analytics**: 用户行为分析
- **Plausible**: 隐私友好的分析工具
- **自建分析**: 使用自定义分析服务

---

## 7. 部署流程

### 7.1 手动部署流程

#### 7.1.1 构建步骤

1. **安装依赖**
   ```bash
   npm install
   ```

2. **配置环境变量**
   - 创建 `.env.production` 文件
   - 配置链 RPC URL、Bundler URL、合约地址等（使用 `VITE_` 前缀）

3. **类型检查**
   ```bash
   npm run type-check
   ```

4. **运行构建**
   ```bash
   npm run build
   ```

5. **验证构建输出**
   - 检查 `dist/` 目录
   - 验证 Service Worker 文件（`workbox-*.js`）
   - 验证 Manifest 文件（`manifest.webmanifest`）

#### 7.1.2 部署步骤

1. **上传构建产物**
   ```bash
   scp -r dist/* user@server:/var/www/wallet/
   ```

2. **配置 Web 服务器**（参考 2.1 节 Nginx 配置）

3. **验证部署**
   - 访问 https://wallet.example.com
   - 验证 PWA 功能
   - 测试钱包功能

### 7.2 自动化部署（CI/CD）

#### 7.2.1 GitHub Actions 示例

```yaml
name: Build and Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run type-check
      
      - name: Build
        run: npm run build
        env:
          VITE_MANTLE_RPC_URL: ${{ secrets.MANTLE_RPC_URL }}
          VITE_MANTLE_BUNDLER_URL: ${{ secrets.MANTLE_BUNDLER_URL }}
          VITE_MANTLE_KERNEL_FACTORY_ADDRESS: ${{ secrets.MANTLE_KERNEL_FACTORY_ADDRESS }}
          VITE_MANTLE_ENTRYPOINT_ADDRESS: ${{ secrets.MANTLE_ENTRYPOINT_ADDRESS }}
      
      - name: Deploy
        run: |
          # 部署脚本
          scp -r dist/* user@server:/var/www/wallet/
```

#### 7.1.2 GitLab CI 示例

```yaml
stages:
  - build
  - deploy

build:
  stage: build
  script:
    - yarn install --frozen-lockfile
    - yarn build
  artifacts:
    paths:
      - dist/

deploy:
  stage: deploy
  script:
    - scp -r dist/* user@server:/var/www/wallet/
  only:
    - main
```

### 7.2 手动部署

```bash
# 1. 构建
yarn build

# 2. 上传到服务器
scp -r dist/* user@server:/var/www/wallet/

# 3. 重启服务（如果需要）
ssh user@server "sudo systemctl reload nginx"
```

### 7.3 部署检查清单

- [ ] 构建成功，无错误
- [ ] 环境变量配置正确
- [ ] SSL 证书有效
- [ ] 服务器配置正确
- [ ] 静态资源可访问
- [ ] SPA 路由正常工作
- [ ] HTTPS 强制启用
- [ ] 安全头配置正确
- [ ] 错误监控配置
- [ ] 性能监控配置
- [ ] CDN 配置（如果使用）
- [ ] 备份策略

---

## 总结

本文档提供了 HTML5 版本的完整部署指南，包括构建配置、服务器配置、CDN 配置、性能优化、安全配置、监控和部署流程。部署时请按照本指南进行操作，确保生产环境的安全性、性能和可靠性。

如有问题，请参考其他文档或联系运维团队。

