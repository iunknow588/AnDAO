# AnDaoWallet HTML5 版本系统概述

## 文档信息

- **项目名称**: AnDaoWallet HTML5 版本（@andaowallet/h5）
- **项目版本**: 0.2.0
- **文档版本**: 2.0
- **编制日期**: 2025年1月
- **文档状态**: 正式版
- **基于版本**: Kernel v3（ERC-4337 兼容）

## 目录

1. [系统定位](#1-系统定位)
2. [系统目标](#2-系统目标)
3. [三路径架构设计](#3-三路径架构设计)
4. [技术栈](#4-技术栈)
5. [系统特点](#5-系统特点)
6. [核心功能](#6-核心功能)
7. [运行环境](#7-运行环境)
8. [设计约束与风险](#8-设计约束与风险)

---

## 1. 系统定位

### 1.1 产品定位

**AnDaoWallet HTML5 版本**是基于账户抽象（ERC-4337）技术构建的智能合约钱包 PWA 应用，**完全无服务端，纯客户端实现**。与传统的 EOA（外部账户）钱包不同，AnDaoWallet 使用 Kernel 智能合约账户，提供更强大的功能、更高的安全性和更好的用户体验。

**核心定位**：
- ✅ **完全独立的智能合约钱包**：架构完全独立，不依赖任何传统钱包（如 Keplr、MetaMask）的核心代码
- ✅ **三路径统一架构**：提供三种账户创建路径，满足不同用户需求（极简体验、标准模式、成为赞助商）
- ✅ **零门槛进入Web3**：路径A允许用户无需EOA账户和Gas代币即可创建智能合约账户
- ✅ **基于 ERC-4337 账户抽象标准**：使用 Kernel 智能合约账户框架
- ✅ **合约代码独立**：合约代码位于 `smart-services/` 目录，使用 Foundry 和 Hardhat 进行开发和部署
- ✅ **支持社交恢复、Gas 代付、批量交易等高级功能**

### 1.2 应用场景

AnDaoWallet HTML5 版本适用于以下场景：

1. **Web3新手用户**：通过路径A（极简体验）零门槛进入Web3，无需理解EOA、Gas等复杂概念
2. **已有EOA钱包用户**：通过路径B（标准模式）获得智能合约账户功能，同时保留EOA兼容性
3. **生态贡献者**：通过路径C（成为赞助商）帮助他人创建账户，构建社区网络
4. **智能合约钱包用户**：需要社交恢复、Gas 代付等高级功能的用户
5. **复杂链上交互**：需要支持批量交易、条件交易等复杂场景
6. **移动设备用户**：在移动浏览器中使用钱包功能，无需安装扩展
7. **跨平台访问**：在任何支持现代 Web 标准的设备上使用
8. **DApp 开发者**：需要可编程钱包功能的 DApp 开发者

### 1.3 设计原则

- **三路径统一**：同一应用，三种入口，满足不同用户需求
- **渐进式复杂度**：从简单到高级，不强制要求
- **路径可转换**：用户可在后续使用中切换路径
- **统一体验**：最终都进入智能合约钱包主界面
- **账户抽象优先**：完全基于智能合约账户，不依赖传统 EOA（路径A）
- **模块化设计**：支持插件系统，可扩展钱包功能
- **用户体验优先**：提供流畅的 Web 应用体验，支持 Gas 代付降低使用门槛
- **安全性增强**：支持社交恢复，私钥丢失不再是资产末日
- **可编程性**：支持高级交易构造器，满足复杂业务场景需求

---

## 2. 系统目标

### 2.1 功能目标

#### 核心账户功能
- ✅ **三路径账户创建**：路径A（极简体验）、路径B（标准模式）、路径C（成为赞助商）
- ✅ **智能合约账户**：基于 Kernel 智能合约账户，支持 ERC-4337 标准
- ✅ **自动密钥生成**：系统自动生成签名密钥，用户无需提供EOA私钥
- ✅ **赞助商代付机制**：路径A用户通过赞助商代付Gas创建账户
- ✅ **路径转换**：用户可在后续使用中切换路径

#### 高级功能
- ✅ **社交恢复**：支持守护人机制，私钥丢失可通过社交恢复找回账户
- ✅ **Gas 代付**：支持 Paymaster，第三方可为用户支付 Gas 费用
- ✅ **批量交易**：支持一次签名执行多个交易
- ✅ **高级交易构造器**：插件化框架，支持比特承诺、延迟交易等复杂交互
- ✅ **多链支持**：支持所有 EVM 兼容链（通过 Kernel 部署）
- ✅ **插件系统**：支持 ERC-7579 插件，可扩展钱包功能
- ✅ **DApp 集成**：提供标准的钱包 Provider 接口，支持 DApp 集成

### 2.2 技术目标

- ✅ **高性能**：优化代码分割，减少初始加载时间
- ✅ **响应式设计**：支持桌面端和移动端
- ✅ **浏览器兼容**：支持主流现代浏览器（Chrome、Firefox、Safari、Edge）
- ✅ **安全性**：密钥本地加密存储，支持硬件钱包，遵循安全最佳实践
- ✅ **无服务端**：完全客户端实现，不依赖自建后端

### 2.3 用户体验目标

- ✅ **零门槛进入**：路径A让Web3新手无需EOA和Gas即可创建账户
- ✅ **快速启动**：优化首屏加载时间
- ✅ **流畅交互**：60fps 的交互体验
- ✅ **清晰导航**：直观的界面和导航设计
- ✅ **错误处理**：完善的错误提示和处理机制
- ✅ **路径引导**：清晰的路径选择和转换引导

---

## 3. 三路径架构设计

### 3.1 架构概述

AnDaoWallet 采用**三路径统一架构**，同一应用提供三种入口，满足不同用户需求：

```
应用入口层
├── 路径A：普通用户（无EOA）- 极简体验
│   ├── 目标：最简体验，零门槛
│   ├── 流程：自动生成密钥 → 选择赞助商 → 提交申请 → 等待审核 → 创建成功
│   └── 特点：用户无需理解EOA概念，无需Gas代币
│
├── 路径B：普通用户（有EOA）- 标准模式
│   ├── 目标：已有EOA或想要EOA的用户
│   ├── 流程：设置EOA → 生成智能账户密钥 → 选择Gas支付方式 → 创建账户
│   └── 特点：用户同时拥有EOA和智能账户，完全兼容所有DApp
│
└── 路径C：赞助商
    ├── 目标：帮助他人并可能获利
    ├── 流程：注册赞助商 → 设置Gas账户 → 设置审核规则 → 开始审核
    └── 特点：需要EOA账户支付Gas，可设置审核规则和渠道
```

### 3.2 路径A：极简体验（无EOA用户）

**目标用户**：
- Web3新手，第一次使用加密货币钱包
- 没有ETH/MNT等Gas代币
- 不想管理复杂的私钥和Gas费用
- 希望最简单的方式获得智能合约账户功能

**核心特点**：
- ✅ 自动生成智能账户密钥对（本地生成，加密存储）
- ✅ 无需EOA账户和Gas代币
- ✅ 赞助商代付所有Gas费用
- ✅ 用户只需管理一套密钥（智能账户控制密钥）
- ✅ 地址预测确保创建后地址一致

**流程**：
1. 选择"极简体验"路径
2. 生成智能合约账户密钥对（本地）
3. 备份助记词
4. 预测智能合约账户地址
5. 选择赞助商（从列表或输入邀请码）
6. 提交创建申请
7. 等待赞助商审核与创建
8. 收到创建成功通知
9. 直接进入智能合约钱包主界面

### 3.3 路径B：标准模式（有EOA用户）

**目标用户**：
- 已有EOA钱包（如MetaMask）的用户
- 想要同时拥有EOA和智能合约账户
- 希望自己控制Gas支付
- 需要完全兼容所有DApp

**核心特点**：
- ✅ 可创建新EOA或导入现有EOA
- ✅ 生成智能账户密钥对（与EOA关联）
- ✅ 可选择自付Gas或申请赞助商代付
- ✅ 完全向后兼容所有需要EOA的DApp
- ✅ 用户管理两套密钥：EOA私钥 + 智能账户控制密钥

**流程**：
1. 选择"标准模式"路径
2. EOA账户设置（创建新EOA或导入现有）
3. 生成智能合约账户密钥对
4. 选择Gas支付方式：
   - 选项A：自己支付Gas（使用EOA中的MNT）
   - 选项B：申请赞助商代付（类似路径A）
5. 创建智能合约账户
6. 进入统一钱包界面，可切换EOA/智能账户视图

### 3.4 路径C：成为赞助商

**目标用户**：
- 已有一定MNT余额的用户
- 愿意帮助他人进入Web3
- 可能希望通过赞助获得收益或声誉
- 有推广渠道或社区资源

**核心特点**：
- ✅ 需要EOA账户专门用于Gas支付
- ✅ 资金隔离：赞助资金与个人资产分离
- ✅ 灵活的审核规则引擎
- ✅ 完整的渠道管理系统
- ✅ 数据分析和效果追踪

**流程**：
1. 选择"成为赞助商"路径
2. 身份验证（已有账户或新注册）
3. 设置赞助商资料（名称、描述等）
4. 配置Gas支付EOA账户
5. 转入初始Gas资金
6. 设置审核规则和渠道
7. 完成链上注册
8. 进入赞助商仪表板

### 3.5 路径转换机制

用户可在后续使用中切换路径：

| 当前路径 | 可转换到 | 转换方式 |
|---------|---------|---------|
| 路径A（无EOA） | 路径B | 添加EOA账户 |
| 路径A（无EOA） | 路径C | 注册赞助商（需创建EOA） |
| 路径B（有EOA） | 路径A | 禁用EOA功能（不推荐） |
| 路径B（有EOA） | 路径C | 注册赞助商（可用现有EOA） |
| 路径C（赞助商） | 路径A/B | 使用智能账户作为普通用户 |

### 3.6 统一主界面

所有路径最终汇合到统一的智能合约钱包主界面：

- **路径A用户**：仅显示智能合约账户视图
- **路径B用户**：可切换EOA账户和智能合约账户视图
- **路径C用户**：可切换用户模式和赞助商模式

---

## 4. 技术栈

### 4.1 核心框架

- **项目名称**: @andaowallet/h5
- **项目版本**: 0.2.0
- **前端框架**: React 18.2.0
- **状态管理**: MobX 6.10.0
- **样式方案**: Styled Components 6.1.1
- **构建工具**: Vite 5.0.5
- **路由**: React Router v6.20.0
- **PWA 支持**: vite-plugin-pwa 0.17.4

### 4.2 账户抽象技术

- **智能合约框架**: Kernel v3（ERC-4337 兼容）
- **合约源码**: 位于 `smart-services/contracts/src` 目录
- **类型定义**: 本地定义在 `src/utils/kernel-types.ts`（不依赖 TypeChain）
- **链交互**: viem 或 ethers.js
- **Bundler**: 支持 ERC-4337 的 Bundler 网络（多服务商故障转移）
- **Paymaster**: Gas 代付服务（可选）

### 4.3 区块链支持

- **优先链**: Mantle Network（EVM 兼容，已部署到测试网）
- **次要链**: Injective Network（待技术验证）
- **支持策略**: MVP 阶段仅支持 Mantle，后续根据 Injective 支持情况决定

### 4.4 已部署的合约（Mantle Sepolia 测试网）

- **Kernel**: `0x7318DdE98c8C70b4652b0C697d8Ee8E2e2d0655F`
- **KernelFactory**: `0x5401b77d3b9BB2ce8757951d03aB6d9aEb22161d`
- **EntryPoint**: `0x0000000071727De22E5E9d8BAf0edAc6f37da032`（ERC-4337 标准地址）

### 4.5 安全与存储

- **加密存储**: Web Crypto API（AES-GCM）
- **本地存储**: IndexedDB（持久化）、LocalStorage（配置）
- **密钥管理**: 三特征密钥系统（StableThreeFeatureKey）
- **密码加密**: PBKDF2 密钥派生（100,000 次迭代）
- **可插拔存储**: 统一的存储接口（IStorageProvider），支持IPFS和自定义存储
  - **默认存储**: IPFS（Pinata/Web3.Storage）
  - **自定义存储**: 赞助商可选择自己的存储方案（自建IPFS、Arweave等）
  - **链上索引**: ApplicationRegistry合约存储存储标识符和类型

---

## 5. 系统特点

### 5.1 架构特点

#### 5.1.1 三路径统一设计

- **同一应用，三种入口**：满足不同用户需求
- **渐进式复杂度**：从简单到高级，不强制要求
- **路径可转换**：用户可在后续使用中切换路径
- **统一体验**：最终都进入智能合约钱包主界面

#### 5.1.2 完全独立的设计

- **架构完全独立**: 不依赖任何传统钱包（如 Keplr、MetaMask）的核心代码
- **基于账户抽象**: 完全基于 ERC-4337 和 Kernel 智能合约账户
- **UI 设计参考**: 界面设计参考 Keplr 钱包，但代码完全独立实现
- **合约代码独立**: 合约代码位于 `smart-services/` 目录，使用 Foundry 和 Hardhat 进行开发和部署
- **无中心化后端**: 只依赖链上 RPC、Bundler、Paymaster 等外部服务；不存储用户数据到自有服务器
- **PWA 约束**: 前台优先，后台监控与推送能力有限

#### 5.1.3 模块化设计

- 清晰的模块边界和依赖关系
- 独立的 Web 应用层，处理路由、导航等 Web 特有功能
- 核心服务层：账户管理、交易中继、消息签名、链管理等
- 适配器层：存储适配器、Provider 适配器

### 5.2 安全特点

#### 5.2.1 密钥安全

- 密钥仅在本地存储，不传输到服务器
- 使用 AES-GCM 加密存储敏感数据
- 自动生成密钥对，用户无需提供EOA私钥
- 硬件钱包支持为规划项（WebUSB/WebHID 集成待实现）

#### 5.2.2 通信安全

- HTTPS 传输
- 安全的跨域通信机制
- DApp 权限管理

#### 5.2.3 运行时安全

- Content Security Policy (CSP)
- XSS 防护
- 安全的第三方库使用

### 5.3 用户体验特点

#### 5.3.1 零门槛进入

- 路径A允许用户无需EOA和Gas即可创建账户
- 自动生成密钥，无需用户提供私钥
- 赞助商代付机制降低使用门槛

#### 5.3.2 响应式设计

- 支持桌面端和移动端
- 自适应布局
- 触摸友好的交互设计

#### 5.3.3 路径引导

- 清晰的路径选择界面
- 详细的路径说明和对比
- 路径转换引导

---

## 6. 核心功能

### 6.1 三路径账户创建功能

1. **路径A：极简体验** ✅
   - 自动生成智能账户密钥对
   - 地址预测
   - 赞助商选择与申请
   - 申请状态跟踪
   - 使用可插拔存储上传申请详情

2. **路径B：标准模式** ✅
   - EOA账户创建/导入
   - 智能账户密钥生成
   - Gas支付方式选择
   - 双账户管理

3. **路径C：成为赞助商** ✅
   - 赞助商注册
   - Gas账户配置
   - 存储方案选择（默认IPFS或自定义）
   - 审核规则设置
   - 渠道管理

### 6.1.1 可插拔存储系统 ✅

1. **存储接口**：
   - IStorageProvider接口定义
   - StorageProviderType枚举
   - 统一的存储方法（add/get/isValid）

2. **默认IPFS实现**：
   - DefaultIPFSStorageProvider类
   - 公共IPFS网关集成
   - Pin服务集成（Pinata/Web3.Storage）

3. **自定义存储支持**：
   - CustomStorageProvider基类
   - 赞助商存储配置管理
   - 存储提供者注册机制

4. **链上索引**：
   - ApplicationRegistry合约（支持存储类型）
   - 存储标识符和类型字段
   - 状态同步机制

### 6.1.2 实现状态与差距（基于代码审查）

本小节用于汇总“设计文档 vs 代码实现”的一致性结论，以及需要继续补齐的功能点，避免系统文档与实现状态脱节。

**已验证与设计一致的实现**：
- ✅ 三路径账户创建页面与核心流程（路径 A/B/C + 欢迎页）
- ✅ 可插拔存储系统（`IStorageProvider` / 默认 IPFS Provider / `StorageProviderManager`）
- ✅ 赞助商服务核心逻辑（注册、申请创建、审核、代付部署）
- ✅ 链上索引合约客户端（`ApplicationRegistryClient`）

**仍需补齐的功能**：
- ⚠️ 助记词导入：存在 TODO，需要集成 `bip39`（含校验与派生）
- ⚠️ 赞助商仪表板：设计存在，但缺少完整 Sponsor Dashboard 页面

### 6.2 智能合约账户功能

1. **账户创建和管理** ✅
   - 创建 Kernel 智能合约账户（AccountManager）
   - 账户地址确定性预测（使用 Factory.getAddress）
   - 多账户管理（AccountStore）
   - 账户锁定/解锁（AuthService）

2. **社交恢复** ✅（框架完成）
   - 添加/移除守护人（GuardianService，基于插件实现）
   - 发起账户恢复（initiateRecovery）
   - 守护人投票（voteForRecovery）
   - 完成账户恢复（需要恢复插件支持）

3. **资产管理** ✅
   - 余额查询（智能合约账户余额，TokenService）
   - 代币管理（TokenService）
   - 转账功能（通过 UserOperation，TransactionRelayer）

### 6.3 账户抽象功能 ✅

- **UserOperation**: 构造和发送用户操作（TransactionRelayer）
- **Gas 代付**: 通过 Paymaster 支付 Gas（PaymasterService，基础支持）
- **批量交易**: 一次签名执行多个交易（TransactionRelayer.sendBatch）
- **Bundler 网络**: 与 Bundler 服务交互（BundlerClient，支持多服务商故障转移）

### 6.4 高级交易构造器 ✅

- **插件系统**: 支持 ERC-7579 插件（PluginService）
- **两阶段提交**: 提交和揭示承诺哈希，支持加密存储原始数据（TwoPhaseCommitService）
- **插件执行**: Executor 和 Hook 插件执行逻辑（已实现）
- **延迟交易**: 支持延迟执行交易（待实现）
- **条件交易**: 支持条件触发交易（待实现）

### 6.5 多链支持 ✅

- **EVM 兼容链**: 支持所有 EVM 兼容链（通过 Kernel 部署）
- **优先链**: Mantle Network（EVM 兼容，优先支持）
- **链管理**: 支持添加和切换链（ChainService）
- **链适配器**: 统一的链配置接口（chains.ts）

### 6.6 DApp 集成 ✅

- **Provider 接口**: 标准的 Ethereum Provider（EIP-1193，ProviderAdapter）
- **钱包发现**: 兼容 EIP-6963 钱包发现标准
- **交互管理**: DApp 请求队列管理（InteractionStore）
- **交易签名**: 通过 UserOperation 签名和发送
- **消息签名**: 支持 eth_sign、personal_sign、eth_signTypedData（SignatureService）

### 6.7 安全功能 ✅

- **社交恢复**: 守护人机制恢复账户（GuardianService，框架完成）
- **加密存储**: 三特征密钥系统（StableThreeFeatureKey、TwoPhaseCommitEncryption）
- **权限管理**: 插件化权限系统（PluginService）
- **自动锁定**: 闲置自动锁定（AuthService）
- **安全提示**: 交易和操作安全提示（SettingsService）

---

## 7. 运行环境

### 7.1 浏览器要求

**最低要求**:
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

**推荐版本**:
- Chrome 100+
- Firefox 100+
- Safari 15+
- Edge 100+

### 7.2 功能支持要求

- **WebAssembly**: 加密算法支持
- **IndexedDB**: 数据持久化
- **WebUSB / WebHID**: 硬件钱包支持（可选）
- **Fetch API**: 网络请求
- **Web Crypto API**: 加密操作

### 7.3 移动设备支持

- **iOS Safari**: iOS 14+
- **Android Chrome**: Android 7+
- **其他移动浏览器**: 根据 Web 标准支持情况

---

## 8. 设计约束与风险

### 8.1 PWA 运行约束

- **无后台长驻任务**：链上轮询需在前台或受限的 Service Worker 内完成，后台监控能力弱于浏览器扩展版
- **前后台切换**：标签页隐藏时应立即锁定或提示用户确认，避免误操作

### 8.2 Bundler/Paymaster 可用性

- **降级路径**：需提供「直连 EntryPoint + 自付 Gas」降级路径，否则在服务不可用时交易无法发送
- **故障转移**：支持多 Bundler 服务商故障转移

### 8.3 社交恢复与高级插件

- **框架完成**：当前仅有框架，恢复投票/执行、延迟/条件交易需补全合约与前端交互

### 8.4 硬件钱包

- **未集成**：未集成 WebUSB/WebHID，后续需要独立威胁建模与 UI 流程

### 8.5 多链支持策略

- **MVP 仅保障 Mantle**：Injective 的 ERC-4337 支持需验证后再放量
- **实验性链标记**：将链分为 stable/experimental 两档，引入链级健康探针

### 8.6 安全与隐私

- **密钥管理**：默认不导出明文密钥，导入/导出需二次确认
- **密码轮换**：需补充密码轮换与全量重加密流程
- **无后端存储**：所有敏感数据仅在本地加密存放；不得依赖自建 API 落地任何用户数据

### 8.7 赞助商机制风险

- **审核延迟**：路径A用户需要等待赞助商审核，可能存在延迟
- **赞助商可用性**：需要足够的活跃赞助商支持路径A用户
- **滥用防护**：需要完善的审核规则和风控机制

---

## 总结

AnDaoWallet HTML5 版本是一个**完全独立的智能合约钱包**，基于账户抽象（ERC-4337）技术构建。通过**三路径统一架构**，我们能够满足从Web3新手到资深用户的所有需求，构建一个健康、可持续的智能合约钱包生态系统。

### 核心优势

1. **三路径统一**：同一应用，三种入口，满足不同用户需求
2. **零门槛进入**：路径A让Web3新手无需EOA和Gas即可创建账户
3. **完全独立**：架构完全独立，不依赖任何传统钱包的核心代码
4. **账户抽象**：基于 ERC-4337 标准，使用 Kernel 智能合约账户
5. **功能完整**：已实现账户管理、交易发送、消息签名、链管理、两阶段提交等核心功能
6. **标准兼容**：实现标准的 Ethereum Provider 接口，兼容 EIP-6963 钱包发现
7. **安全可靠**：支持加密存储、社交恢复框架、三特征密钥系统

### 实现状态

- ✅ **核心功能**: 账户管理、交易中继、消息签名、链管理
- ✅ **三路径架构**: 路径A、B、C的设计和实现框架
- ✅ **高级功能**: 两阶段提交（支持加密存储）、插件执行逻辑
- ✅ **DApp 集成**: Provider 适配器、Interaction Store
- ⚠️ **待完善**: 
  - 可插拔存储系统（存储接口、默认IPFS实现、自定义存储支持）
  - 赞助商审核系统（集成存储）
  - 路径转换功能
  - 完整社交恢复

虽然在某些功能（如后台监控）上存在 Web 环境的限制，但通过合理的设计和实现，HTML5 版本能够满足大多数用户的使用需求，为用户提供安全、便捷的智能合约钱包体验。

---

## 更新日志

- **v0.2.1** (2025-01-13): 
  - 引入可插拔存储架构设计
  - 钱包使用通用IPFS存储（默认）
  - 赞助商可选择自己的存储方案（自定义存储接口）
  - 链上索引合约支持存储类型
  - 更新技术文档和检查清单

- **v0.2.0** (2025-01-13): 
  - 引入三路径统一架构设计
  - 路径A：极简体验（无EOA用户）
  - 路径B：标准模式（有EOA用户）
  - 路径C：成为赞助商
  - 统一处理普通用户和赞助商
  - 自动生成密钥，无需用户提供EOA私钥

- **v0.1.0** (2025-01-13): 
  - 完成核心合约部署到 Mantle Sepolia 测试网
  - Kernel 和 KernelFactory 已成功部署
  - 更新文档以反映实际代码状态
  - 优化合约大小（从 27KB 降至 24KB 以下）
