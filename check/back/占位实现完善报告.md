# 占位实现完善报告

## 文档信息

- **完成日期**: 2024年
- **状态**: 已完成
- **版本**: 1.0

---

## 一、完成的工作

### ✅ 1. Kernel-dev 类型导入

#### 创建类型导入辅助模块

**文件**: `src/utils/kernel-types.ts`

**功能**:
- 提供统一的类型导入接口
- 支持从 kernel-dev 导入（当 artifacts 可用时）
- 提供降级方案（使用本地定义的 ABI）
- 导出 UserOperation 类型定义

**实现方案**:
```typescript
// 优先从 kernel-dev 导入
async function tryImportKernelABI() {
  // 尝试导入 kernel-dev artifacts
  // 失败时返回 null，使用降级方案
}

// 同步版本（直接使用降级方案）
export const KERNEL_FACTORY_ABI = KERNEL_FACTORY_ABI_FALLBACK;
export const KERNEL_ABI = KERNEL_ABI_FALLBACK;
export const ENTRYPOINT_ABI = ENTRYPOINT_ABI_FALLBACK;
```

**更新的文件**:
- ✅ `src/utils/kernel.ts` - 使用新的类型导入模块
- ✅ `src/services/AccountManager.ts` - 更新导入语句
- ✅ `src/services/TransactionRelayer.ts` - 更新 UserOperation 类型导入
- ✅ `src/types/index.ts` - 从 kernel-types 重新导出 UserOperation

---

### ✅ 2. GuardianService 占位实现完善

#### 完善的功能

1. **getGuardians 方法**:
   - ✅ 支持从链上查询守护人列表（通过恢复插件）
   - ✅ 支持从本地存储获取（降级方案）
   - ✅ 自动更新本地存储

2. **addGuardian 方法**:
   - ✅ 通过恢复插件添加守护人
   - ✅ 支持从 ChainConfig 获取恢复插件地址
   - ✅ 更新本地存储

3. **removeGuardian 方法**:
   - ✅ 通过恢复插件移除守护人
   - ✅ 支持从 ChainConfig 获取恢复插件地址
   - ✅ 更新本地存储

4. **删除占位符方法**:
   - ✅ 移除了 `encodeAddGuardianCallData` 和 `encodeRemoveGuardianCallData` 占位符方法
   - ✅ 直接在方法中构造调用数据

**更新的文件**:
- ✅ `src/services/GuardianService.ts`

---

### ✅ 3. KeyManagerService 会话密钥支持

#### 新增功能

1. **getPrivateKeyFromSession 方法**:
   - ✅ 从会话中获取缓存的私钥
   - ✅ 支持会话密钥派生加密密钥
   - ✅ 自动处理过期时间

2. **cachePrivateKeyToSession 方法** (新增):
   - ✅ 缓存私钥到会话（临时存储）
   - ✅ 支持设置过期时间（默认30分钟）
   - ✅ 登出时自动清除

**更新的文件**:
- ✅ `src/services/KeyManagerService.ts`

---

### ✅ 4. ProviderAdapter 私钥获取完善

#### 完善的功能

1. **getSignerPrivateKey 方法**:
   - ✅ 优先从会话获取缓存的私钥
   - ✅ 如果会话中没有，触发UI交互获取密码
   - ✅ 使用密码获取私钥并缓存到会话

2. **requestPasswordFromUI 方法** (新增):
   - ✅ 通过 CustomEvent 触发密码输入UI
   - ✅ 等待UI组件返回密码
   - ✅ 支持超时处理（30秒）
   - ✅ 支持用户取消

**实现方案**:
```typescript
// 1. 触发密码输入事件
window.dispatchEvent(new CustomEvent('wallet:request-password', {
  detail: { requestId, address, purpose }
}));

// 2. 监听密码输入完成事件
window.addEventListener('wallet:password-input', handlePasswordInput);
window.addEventListener('wallet:password-cancel', handlePasswordCancel);
```

**更新的文件**:
- ✅ `src/adapters/ProviderAdapter.ts`

---

### ✅ 5. ChainConfig 类型扩展

#### 新增字段

- ✅ `recoveryPluginAddress?: string` - 恢复插件合约地址

**用途**:
- GuardianService 可以从 ChainConfig 自动获取恢复插件地址
- 支持在链配置中预设恢复插件地址

**更新的文件**:
- ✅ `src/types/index.ts`

---

## 二、实现细节

### 1. 类型导入策略

**当前实现**:
- 使用降级方案（本地定义的 ABI）
- 当 kernel-dev 编译完成后，可以无缝切换到实际导入

**未来改进**:
1. 编译 kernel-dev: `cd kernel-dev && npm run compile`
2. 运行 TypeChain: `cd h5 && npm run typechain`
3. 更新 `kernel-types.ts` 中的 `tryImportKernelABI` 方法，使用实际导入

### 2. 守护人管理流程

**完整流程**:
1. 用户调用 `addGuardian` 或 `removeGuardian`
2. 如果没有提供恢复插件地址，从 ChainConfig 获取
3. 构造调用恢复插件的交易数据
4. 通过 TransactionRelayer 发送交易
5. 更新本地存储

**恢复插件接口**:
```solidity
// 标准恢复插件接口
function addGuardian(address guardian) external returns (bool);
function removeGuardian(address guardian) external returns (bool);
function getGuardians() external view returns (address[]);
function initiateRecovery(address newOwner) external returns (bytes32);
function voteForRecovery(bytes32 recoveryId) external returns (bool);
```

### 3. 私钥获取流程

**完整流程**:
1. 尝试从会话获取缓存的私钥
2. 如果会话中没有，触发密码输入UI
3. 用户输入密码后，从 KeyManagerService 获取私钥
4. 将私钥缓存到会话中（30分钟）
5. 返回私钥

**安全考虑**:
- 私钥只在会话中临时缓存（30分钟）
- 登出时自动清除所有缓存的私钥
- 密码输入UI需要用户确认

---

## 三、待完成的工作

### ⏳ 1. UI 组件实现

**需要实现的组件**:
- 密码输入对话框组件
- 监听 `wallet:request-password` 事件
- 触发 `wallet:password-input` 或 `wallet:password-cancel` 事件

**建议位置**: `src/components/PasswordInput/PasswordInput.tsx`

### ⏳ 2. Kernel-dev 实际导入

**步骤**:
1. 编译 kernel-dev
2. 运行 TypeChain 生成类型
3. 更新 `kernel-types.ts` 使用实际导入

### ⏳ 3. 恢复插件地址配置

**需要配置的链**:
- Mantle 主网
- Mantle 测试网
- Injective（如果支持）

**配置位置**: `src/config/chains.ts`

---

## 四、测试建议

### 1. 单元测试

- [ ] GuardianService 的守护人管理方法
- [ ] KeyManagerService 的会话密钥方法
- [ ] ProviderAdapter 的私钥获取方法

### 2. 集成测试

- [ ] 完整的守护人添加/移除流程
- [ ] 私钥获取和缓存流程
- [ ] 密码输入UI交互流程

### 3. E2E 测试

- [ ] 守护人管理完整流程
- [ ] 社交恢复完整流程
- [ ] 签名功能（需要密码输入）

---

## 五、总结

### 完成度

- ✅ **类型导入**: 90% (框架完成，等待 kernel-dev 编译)
- ✅ **GuardianService**: 85% (功能完善，等待恢复插件地址配置)
- ✅ **KeyManagerService**: 90% (会话密钥支持完成)
- ✅ **ProviderAdapter**: 85% (私钥获取完善，等待UI组件)

### 主要改进

1. **统一类型导入**: 创建了 `kernel-types.ts` 模块，统一管理类型导入
2. **完善占位实现**: GuardianService 现在可以通过恢复插件实际调用
3. **会话密钥支持**: KeyManagerService 支持会话密钥缓存
4. **私钥获取流程**: ProviderAdapter 实现了完整的私钥获取流程

### 下一步

1. 实现密码输入UI组件
2. 配置恢复插件地址
3. 编译 kernel-dev 并更新类型导入
4. 编写测试用例

---

**报告版本**: 1.0
**最后更新**: 2024年

