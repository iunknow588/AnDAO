# 接口完善说明

## 更新日期
2024年

## 概述

根据现有框架说明，完善了以下接口的实现：

1. **DelayedTransactionPlugin** - 延迟交易插件接口
2. **ConditionalTransactionPlugin** - 条件交易插件接口

## 完善的接口

### 1. DelayedTransactionPlugin（延迟交易插件）

#### 1.1 scheduleTransaction 方法

**完善内容**：
- ✅ 添加了 `signerPrivateKey` 参数，用于发送调度交易
- ✅ 实现了与插件合约的交互，调用 `schedule` 方法
- ✅ 添加了交易哈希计算，用于在插件合约中标识交易
- ✅ 实现了完整的错误处理和状态管理

**接口签名**：
```typescript
async scheduleTransaction(
  accountAddress: Address,
  chainId: number,
  config: DelayedTransactionConfig,
  signerPrivateKey: `0x${string}`
): Promise<DelayedTransaction>
```

**插件合约接口**：
```solidity
function schedule(
  bytes32 transactionHash,
  address target,
  uint256 value,
  bytes calldata data,
  uint256 delay
) external
```

#### 1.2 cancelTransaction 方法

**完善内容**：
- ✅ 添加了 `accountAddress`、`chainId`、`signerPrivateKey` 参数
- ✅ 实现了与插件合约的交互，调用 `cancel` 方法
- ✅ 添加了交易哈希计算（与schedule时一致）
- ✅ 返回交易哈希

**接口签名**：
```typescript
async cancelTransaction(
  transactionId: string,
  accountAddress: Address,
  chainId: number,
  signerPrivateKey: `0x${string}`
): Promise<string>
```

**插件合约接口**：
```solidity
function cancel(bytes32 transactionHash) external
```

#### 1.3 executeTransaction 方法

**完善内容**：
- ✅ 从私有方法改为公共方法
- ✅ 添加了 `signerPrivateKey` 参数
- ✅ 实现了与插件合约的交互，调用 `execute` 方法
- ✅ 添加了状态验证和交易哈希计算
- ✅ 返回交易哈希

**接口签名**：
```typescript
async executeTransaction(
  transaction: DelayedTransaction,
  signerPrivateKey: `0x${string}`
): Promise<string>
```

**插件合约接口**：
```solidity
function execute(bytes32 transactionHash) external
```

#### 1.4 checkAndExecuteDueTransactions 方法

**完善内容**：
- ✅ 添加了 `signerPrivateKey` 参数
- ✅ 返回执行的交易数量
- ✅ 完善了错误处理

**接口签名**：
```typescript
async checkAndExecuteDueTransactions(
  signerPrivateKey: `0x${string}`
): Promise<number>
```

### 2. ConditionalTransactionPlugin（条件交易插件）

#### 2.1 CONTRACT_STATE 条件检查

**完善内容**：
- ✅ 实现了合约状态查询功能
- ✅ 支持查询任意合约的状态变量或调用view函数
- ✅ 支持自定义ABI和参数

**参数格式**：
```typescript
{
  address: Address,        // 合约地址
  functionName: string,   // 函数名或状态变量名
  abi: any[],            // 合约ABI
  args?: any[]           // 函数参数（可选）
}
```

**示例**：
```typescript
const condition: Condition = {
  type: ConditionType.CONTRACT_STATE,
  params: {
    address: '0x...', // ERC-20代币地址
    functionName: 'balanceOf',
    abi: ERC20_ABI,
    args: ['0x...'] // 账户地址
  },
  operator: 'gte',
  expectedValue: 1000000 // 期望余额
};
```

#### 2.2 executeTransaction 方法

**完善内容**：
- ✅ 实现了与插件合约的交互，调用 `execute` 方法
- ✅ 添加了条件再次验证（确保条件仍然满足）
- ✅ 添加了交易哈希计算
- ✅ 完善了状态管理和监控停止

**接口签名**：
```typescript
async executeTransaction(
  transactionId: string,
  signerPrivateKey: Hex
): Promise<string>
```

**插件合约接口**：
```solidity
function execute(
  bytes32 transactionHash,
  address target,
  uint256 value,
  bytes calldata data
) external
```

#### 2.3 cancelTransaction 方法

**完善内容**：
- ✅ 添加了 `accountAddress`、`chainId` 参数
- ✅ `signerPrivateKey` 参数改为可选
- ✅ 如果提供了私钥，调用插件合约的 `cancel` 方法
- ✅ 如果未提供私钥，仅更新本地状态

**接口签名**：
```typescript
async cancelTransaction(
  transactionId: string,
  accountAddress: Address,
  chainId: number,
  signerPrivateKey?: Hex
): Promise<string | void>
```

**插件合约接口**：
```solidity
function cancel(bytes32 transactionHash) external
```

## 技术实现细节

### 交易哈希计算

所有插件都使用一致的交易哈希计算方式：

1. **DelayedTransactionPlugin**：
   ```typescript
   keccak256(encodeAbiParameters(
     parseAbiParameters('address, uint256, bytes, uint256'),
     [target, value, data, delay]
   ))
   ```

2. **ConditionalTransactionPlugin**：
   ```typescript
   keccak256(encodeAbiParameters(
     parseAbiParameters('address, uint256, bytes, bytes32'),
     [target, value, data, conditionsHash]
   ))
   ```

### 与TransactionRelayer集成

所有插件都通过 `TransactionRelayer` 发送交易：

```typescript
const txHash = await transactionRelayer.sendTransaction(
  accountAddress,
  chainId,
  pluginAddress, // 插件合约地址
  callData,      // 编码的调用数据
  signerPrivateKey
);
```

### 错误处理

所有方法都包含完整的错误处理：
- 参数验证
- 状态检查
- 交易失败处理
- 本地状态同步

## 使用示例

### DelayedTransactionPlugin

```typescript
import { DelayedTransactionPlugin } from '@/plugins/DelayedTransactionPlugin';

const plugin = new DelayedTransactionPlugin(pluginAddress);

// 调度延迟交易
const transaction = await plugin.scheduleTransaction(
  accountAddress,
  chainId,
  {
    delaySeconds: 3600, // 1小时后执行
    target: '0x...',
    data: '0x...',
    value: 0n,
  },
  signerPrivateKey
);

// 检查并执行到期交易
const executedCount = await plugin.checkAndExecuteDueTransactions(signerPrivateKey);

// 取消交易
await plugin.cancelTransaction(
  transaction.id,
  accountAddress,
  chainId,
  signerPrivateKey
);
```

### ConditionalTransactionPlugin

```typescript
import { ConditionalTransactionPlugin, ConditionType } from '@/plugins/ConditionalTransactionPlugin';

const plugin = new ConditionalTransactionPlugin(pluginAddress);

// 创建条件交易
const transaction = await plugin.createConditionalTransaction(
  accountAddress,
  chainId,
  {
    conditions: [
      {
        type: ConditionType.BALANCE,
        params: { address: accountAddress },
        operator: 'gte',
        expectedValue: 1000000000000000000n, // 1 ETH
      },
      {
        type: ConditionType.CONTRACT_STATE,
        params: {
          address: tokenAddress,
          functionName: 'balanceOf',
          abi: ERC20_ABI,
          args: [accountAddress],
        },
        operator: 'gte',
        expectedValue: 1000,
      },
    ],
    target: '0x...',
    data: '0x...',
    value: 0n,
  }
);

// 当条件满足时执行
const txHash = await plugin.executeTransaction(transaction.id, signerPrivateKey);
```

## 注意事项

1. **插件安装**：使用插件前，需要先通过 `PluginService` 安装插件到账户中
2. **签名者私钥**：所有需要发送交易的方法都需要提供签名者私钥
3. **交易哈希一致性**：取消和执行交易时使用的交易哈希必须与调度时一致
4. **条件验证**：ConditionalTransactionPlugin在执行前会再次验证条件
5. **监控停止**：交易执行或取消后，会自动停止监控

## 后续改进建议

1. **批量操作**：支持批量调度、取消和执行交易
2. **事件监听**：添加事件监听，实时获取交易状态更新
3. **重试机制**：添加交易失败重试机制
4. **Gas优化**：优化Gas使用，支持Gas代付
5. **多链支持**：确保插件在不同链上的兼容性

---

**文档版本**：1.0  
**最后更新**：2024年
