# AnDaoWallet 账户抽象架构说明

## 文档信息

- **项目名称**: AnDaoWallet HTML5 版本
- **文档版本**: 1.0
- **编制日期**: 2024年
- **文档状态**: 正式版

## 目录

1. [账户抽象概述](#1-账户抽象概述)
2. [Kernel 智能合约账户](#2-kernel-智能合约账户)
3. [ERC-4337 标准](#3-erc-4337-标准)
4. [系统架构](#4-系统架构)
5. [核心组件](#5-核心组件)
6. [工作流程](#6-工作流程)
7. [与传统钱包的区别](#7-与传统钱包的区别)

---

## 1. 账户抽象概述

### 1.1 什么是账户抽象

账户抽象（Account Abstraction，AA）是 Ethereum 生态系统中的一项重要技术，旨在将智能合约的功能引入到用户账户中，使智能合约账户能够像外部账户（EOA）一样执行交易。

### 1.2 核心优势

1. **无需私钥管理**: 用户可以通过多种方式控制账户（签名密钥、社交恢复等）
2. **Gas 代付**: 支持第三方为用户的交易支付 Gas 费用
3. **批量交易**: 可以在一次操作中执行多个交易
4. **可编程逻辑**: 账户本身是智能合约，可以执行复杂的业务逻辑
5. **更好的安全性**: 支持多重签名、时间锁、权限管理等安全特性

### 1.3 ERC-4337 标准

ERC-4337 是账户抽象的实现标准，它通过 UserOperation 和 EntryPoint 合约实现了账户抽象，无需修改以太坊协议层。

---

## 2. Kernel 智能合约账户

### 2.1 Kernel 简介

Kernel 是一个高度优化的、模块化的智能合约账户实现，具有以下特点：

- ✅ **ERC-4337 兼容**: 完全符合 ERC-4337 标准
- ✅ **模块化设计**: 支持 ERC-7579 插件系统
- ✅ **Gas 高效**: 业界最 Gas 高效的智能合约账户之一
- ✅ **经过审计**: 获得 Ethereum AA Grant，被广泛使用

### 2.2 Kernel 架构

```
┌─────────────────────────────────────────┐
│         Kernel Smart Account            │
│  ┌───────────────────────────────────┐  │
│  │   Validator Module (ECDSA)        │  │  ← 签名验证
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │   Execution Module               │  │  ← 交易执行
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │   Plugin System (ERC-7579)       │  │  ← 插件扩展
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 2.3 Kernel 核心组件

1. **Validator（验证器）**: 负责验证用户操作的签名
   - ECDSA Validator: 标准 ECDSA 签名验证
   - 可扩展: 支持自定义验证逻辑

2. **Execution（执行器）**: 负责执行用户操作
   - 单笔交易执行
   - 批量交易执行
   - 委托调用支持

3. **Plugin System（插件系统）**: 支持功能扩展
   - ERC-7579 标准
   - 权限管理插件
   - 会话密钥插件
   - 自定义业务逻辑插件

---

## 3. ERC-4337 标准

### 3.1 UserOperation

UserOperation 是 ERC-4337 中的核心概念，它代表一个用户操作请求：

```typescript
interface UserOperation {
  sender: string;           // 智能合约账户地址
  nonce: bigint;           // 账户 nonce
  initCode: string;        // 账户初始化代码（首次创建时）
  callData: string;        // 调用数据
  callGasLimit: bigint;    // 调用 Gas 限制
  verificationGasLimit: bigint;  // 验证 Gas 限制
  preVerificationGas: bigint;    // 预验证 Gas
  maxFeePerGas: bigint;    // 最大 Gas 价格
  maxPriorityFeePerGas: bigint;   // 最大优先费用
  paymasterAndData: string;      // Paymaster 数据（Gas 代付）
  signature: string;       // 签名
}
```

### 3.2 EntryPoint 合约

EntryPoint 是 ERC-4337 的核心合约，负责：

1. **验证 UserOperation**: 调用账户的 `validateUserOp` 方法
2. **执行 UserOperation**: 调用账户的执行逻辑
3. **处理 Paymaster**: 如果使用 Gas 代付，处理 Paymaster 逻辑

### 3.3 Bundler

Bundler 是一个网络服务，负责：

1. **接收 UserOperation**: 从用户或 DApp 接收 UserOperation
2. **打包交易**: 将多个 UserOperation 打包成单个交易
3. **发送到链上**: 将打包后的交易发送到区块链

### 3.4 Paymaster

Paymaster 是一个智能合约，负责：

1. **Gas 代付**: 为用户支付交易 Gas 费用
2. **条件验证**: 可以设置代付条件（如白名单、代币类型等）

---

## 4. 系统架构

### 4.1 整体架构

```
┌─────────────────────────────────────────┐
│         AnDaoWallet PWA                  │
│  ┌───────────────────────────────────┐   │
│  │   UI Layer (React)               │   │
│  └───────────────────────────────────┘   │
│  ┌───────────────────────────────────┐   │
│  │   Wallet Core SDK                │   │
│  │   - AccountManager               │   │
│  │   - TransactionRelayer           │   │
│  │   - SecurityVault               │   │
│  └───────────────────────────────────┘   │
│  ┌───────────────────────────────────┐   │
│  │   AA SDK (ZeroDev/Viem)          │   │
│  │   - Kernel Account               │   │
│  │   - UserOperation Builder        │   │
│  └───────────────────────────────────┘   │
└───────────────┬─────────────────────────┘
                │
                │ (UserOperation)
                ▼
┌─────────────────────────────────────────┐
│         Bundler Network                 │
│  - 接收 UserOperation                   │
│  - 打包并发送到 EntryPoint              │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│         EntryPoint Contract             │
│  - 验证 UserOperation                  │
│  - 执行交易                             │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│         Kernel Smart Account            │
│  - 用户资产存储                          │
│  - 执行逻辑                              │
└─────────────────────────────────────────┘
```

### 4.2 核心模块

#### 4.2.1 AccountManager（账户管理器）

负责管理智能合约账户的创建、恢复和查询：

```typescript
class AccountManager {
  // 创建新账户
  async createAccount(owner: string): Promise<string>;
  
  // 获取账户地址
  async getAccountAddress(owner: string): Promise<string>;
  
  // 获取账户实例
  async getAccount(owner: string): Promise<KernelAccount>;
  
  // 社交恢复相关
  async addGuardian(account: string, guardian: string): Promise<void>;
  async initiateRecovery(account: string, newOwner: string): Promise<void>;
  async completeRecovery(account: string): Promise<void>;
}
```

#### 4.2.2 TransactionRelayer（交易中继器）

负责构造和发送 UserOperation：

```typescript
class TransactionRelayer {
  // 发送单笔交易
  async sendTransaction(
    account: KernelAccount,
    target: string,
    data: string
  ): Promise<string>;
  
  // 发送批量交易
  async sendBatch(
    account: KernelAccount,
    transactions: Transaction[]
  ): Promise<string>;
  
  // 发送 UserOperation
  async sendUserOp(
    account: KernelAccount,
    userOp: UserOperation
  ): Promise<string>;
}
```

#### 4.2.3 SecurityVault（安全存储）

负责安全存储用户数据：

```typescript
class SecurityVault {
  // 加密存储
  async setItem(key: string, value: any): Promise<void>;
  
  // 解密读取
  async getItem(key: string): Promise<any>;
  
  // 删除数据
  async removeItem(key: string): Promise<void>;
}
```

---

## 5. 核心组件

### 5.1 Kernel Factory

Kernel Factory 是用于创建 Kernel 账户的工厂合约：

```solidity
contract KernelFactory {
    function createAccount(
        address owner,
        bytes32 salt
    ) external returns (address account);
    
    function getAddress(
        address owner,
        bytes32 salt
    ) external view returns (address);
}
```

### 5.2 Kernel Account

Kernel Account 是用户的智能合约账户：

```solidity
contract Kernel {
    function validateUserOp(
        UserOperation calldata userOp,
        bytes32 userOpHash,
        uint256 missingAccountFunds
    ) external returns (uint256 validationData);
    
    function execute(
        address target,
        uint256 value,
        bytes calldata data
    ) external;
    
    function executeBatch(
        address[] calldata targets,
        uint256[] calldata values,
        bytes[] calldata datas
    ) external;
}
```

### 5.3 ECDSA Validator

ECDSA Validator 负责验证 ECDSA 签名：

```solidity
contract ECDSAValidator {
    function validateSignature(
        bytes32 hash,
        bytes calldata signature
    ) external view returns (uint256);
}
```

---

## 6. 工作流程

### 6.1 创建账户流程

```
1. 用户发起创建账户请求
   ↓
2. AccountManager 调用 Kernel Factory
   ↓
3. Factory 部署 Kernel 账户合约
   ↓
4. 账户地址返回给用户
   ↓
5. 用户可以使用新账户
```

### 6.2 发送交易流程

```
1. 用户在 UI 中构造交易
   ↓
2. Wallet Core 调用 AA SDK 构造 UserOperation
   ↓
3. 使用用户签名密钥签名 UserOperation
   ↓
4. TransactionRelayer 发送 UserOperation 到 Bundler
   ↓
5. Bundler 打包并发送到 EntryPoint
   ↓
6. EntryPoint 验证并执行交易
   ↓
7. 交易结果返回给用户
```

### 6.3 Gas 代付流程

```
1. 用户构造交易（设置 paymasterAndData）
   ↓
2. EntryPoint 验证 Paymaster 条件
   ↓
3. Paymaster 支付 Gas 费用
   ↓
4. 交易执行成功
   ↓
5. 用户无需支付 Gas
```

### 6.4 社交恢复流程

```
1. 用户丢失签名密钥
   ↓
2. 用户发起恢复请求
   ↓
3. 守护人投票（达到阈值）
   ↓
4. 账户更换签名密钥
   ↓
5. 用户可以使用新密钥控制账户
```

---

## 7. 与传统钱包的区别

### 7.1 账户类型

| 特性 | 传统 EOA 钱包 | AnDaoWallet (智能合约钱包) |
|------|-------------|-------------------------|
| 账户类型 | 外部账户（EOA） | 智能合约账户 |
| 地址生成 | 从私钥派生 | 由 Factory 合约部署 |
| 资产存储 | 账户地址直接持有 | 智能合约账户持有 |
| 控制方式 | 私钥签名 | 多种方式（签名、社交恢复等） |

### 7.2 功能对比

| 功能 | 传统钱包 | AnDaoWallet |
|------|-----------|-----------|
| 私钥恢复 | ❌ 不支持 | ✅ 社交恢复 |
| Gas 代付 | ❌ 不支持 | ✅ 支持 Paymaster |
| 批量交易 | ❌ 需要多次签名 | ✅ 一次签名 |
| 条件交易 | ❌ 不支持 | ✅ 支持 |
| 延迟交易 | ❌ 不支持 | ✅ 支持 |
| 插件扩展 | ❌ 不支持 | ✅ ERC-7579 插件 |

### 7.3 安全性对比

| 安全特性 | 传统钱包 | AnDaoWallet |
|---------|---------|------------|
| 私钥丢失 | 资产永久丢失 | 可通过社交恢复 |
| 多重签名 | 需要额外服务 | 原生支持 |
| 权限管理 | 不支持 | 支持插件化权限 |
| 时间锁 | 不支持 | 支持插件实现 |

---

## 总结

AnDaoWallet 基于账户抽象（ERC-4337）和 Kernel 智能合约账户，提供了比传统钱包更强大、更安全、更灵活的功能。通过智能合约账户，用户可以享受 Gas 代付、社交恢复、批量交易等高级特性，同时保持对资产的完全控制。

这种架构特别适合需要复杂链上交互的场景，如比特承诺、延迟投票、条件交易等，为 DApp 开发者提供了强大的基础设施。

