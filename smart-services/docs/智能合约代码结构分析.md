# AnDaoWallet 智能合约代码结构分析文档

## 文档信息
- **项目名称**: AnDaoWallet Smart Services
- **版本**: 3.0.0
- **文档创建日期**: 2025-01-13
- **合约框架**: Kernel (ERC-4337 兼容的智能合约账户框架)

---

## 1. 项目概述

### 1.1 项目简介
AnDaoWallet 智能合约服务基于 Kernel 框架构建，实现了 ERC-4337 (Account Abstraction) 标准的智能合约钱包。该框架支持模块化设计，允许用户自定义验证器、执行器、钩子等组件。

### 1.2 技术栈
- **Solidity 版本**: ^0.8.0
- **开发框架**: Hardhat + Foundry
- **标准协议**: 
  - ERC-4337 (Account Abstraction)
  - ERC-7579 (Module System)
  - EIP-712 (Typed Structured Data Hashing)

---

## 2. 目录结构

```
smart-services/
├── contracts/              # 智能合约源码
│   └── src/               # Kernel 合约核心代码
│       ├── Kernel.sol     # 主合约（智能账户核心实现）
│       ├── core/          # 核心管理模块
│       │   ├── ValidationManager.sol    # 验证管理器
│       │   ├── ExecutorManager.sol      # 执行管理器
│       │   ├── HookManager.sol          # 钩子管理器
│       │   └── SelectorManager.sol      # 选择器管理器
│       ├── factory/       # 工厂合约
│       │   ├── KernelFactory.sol         # Kernel 账户工厂
│       │   └── FactoryStaker.sol        # 工厂质押合约
│       ├── validator/     # 验证器模块
│       │   ├── ECDSAValidator.sol       # ECDSA 签名验证器
│       │   ├── MultiChainValidator.sol  # 多链验证器
│       │   ├── WeightedECDSAValidator.sol # 加权 ECDSA 验证器
│       │   └── EmitIdentifierValidator.sol # 事件标识符验证器
│       ├── signer/        # 签名器模块
│       │   └── MultiChainSigner.sol     # 多链签名器
│       ├── interfaces/    # 接口定义
│       │   ├── IAccount.sol             # 账户接口
│       │   ├── IAccountExecute.sol      # 账户执行接口
│       │   ├── IEntryPoint.sol          # EntryPoint 接口
│       │   ├── IERC7579Account.sol      # ERC-7579 账户接口
│       │   ├── IERC7579Modules.sol      # ERC-7579 模块接口
│       │   ├── IPaymaster.sol          # Paymaster 接口
│       │   └── PackedUserOperation.sol  # 打包用户操作
│       ├── sdk/          # SDK 模块
│       │   ├── moduleBase/
│       │   │   ├── PolicyBase.sol       # 策略基类
│       │   │   └── SignerBase.sol       # 签名器基类
│       │   └── ModuleStorageLib.sol     # 模块存储库
│       ├── types/        # 类型定义
│       │   ├── Types.sol                # 核心类型
│       │   ├── Structs.sol              # 结构体定义
│       │   └── Constants.sol            # 常量定义
│       └── utils/        # 工具库
│           ├── ExecLib.sol              # 执行库
│           ├── ModuleLib.sol            # 模块库
│           ├── Utils.sol                # 通用工具
│           ├── ValidationTypeLib.sol   # 验证类型库
│           └── KernelValidationResult.sol # 验证结果处理
├── scripts/              # 部署脚本
│   ├── Deploy.s.sol      # 主部署脚本
│   ├── DeployKernel.s.sol # Kernel 部署脚本
│   └── DeployECDSA.s.sol  # ECDSA 验证器部署脚本
├── artifacts/            # 编译产物
├── types/                # TypeScript 类型定义
├── hardhat.config.ts     # Hardhat 配置
├── foundry.toml          # Foundry 配置
├── remappings.txt        # Foundry 重映射配置
└── package.json          # 项目依赖配置
```

---

## 3. 核心组件分析

### 3.1 Kernel.sol - 主合约

**功能**: 智能合约账户的核心实现，实现了 ERC-4337 和 ERC-7579 标准。

**主要特性**:
- 支持 UserOperation 验证和执行
- 模块化架构，支持动态安装/卸载模块
- 支持多种验证模式（Root Validator, Validator, Permission）
- 支持钩子（Hook）机制
- 支持执行器（Executor）扩展

**关键接口实现**:
- `IAccount`: 账户验证接口
- `IAccountExecute`: 账户执行接口
- `IERC7579Account`: ERC-7579 模块化账户接口

**核心方法**:
```solidity
// 验证用户操作
function validateUserOp(PackedUserOperation calldata userOp, bytes32 userOpHash)
    external
    view
    returns (uint256 validationData)

// 执行用户操作
function executeUserOp(PackedUserOperation calldata userOp, bytes32 userOpHash)
    external
    payable

// 执行交易
function execute(bytes calldata _target, uint256 _value, bytes calldata _calldata)
    external
    payable
```

---

### 3.2 核心管理模块 (core/)

#### 3.2.1 ValidationManager.sol - 验证管理器

**功能**: 管理账户的验证逻辑，支持多种验证模式。

**主要功能**:
- **Root Validator 管理**: 管理根验证器，作为账户的主要验证方式
- **Validator 管理**: 支持安装/卸载多个验证器
- **Permission 管理**: 支持细粒度的权限控制
- **Nonce 管理**: 管理交易 nonce，防止重放攻击
- **验证模式**: 
  - `VALIDATION_MODE_DEFAULT`: 默认验证模式
  - `VALIDATION_MODE_ENABLE`: 启用验证模式

**验证类型**:
- `VALIDATION_TYPE_ROOT`: 根验证器类型
- `VALIDATION_TYPE_VALIDATOR`: 验证器类型
- `VALIDATION_TYPE_PERMISSION`: 权限类型
- `VALIDATION_TYPE_7702`: EIP-7702 类型

**关键数据结构**:
```solidity
struct ValidationConfig {
    uint32 nonce;
    IHook hook;
}

struct PermissionConfig {
    PassFlag permissionFlag;
    ISigner signer;
    PolicyData[] policyData;
}
```

#### 3.2.2 ExecutorManager.sol - 执行管理器

**功能**: 管理账户的执行器模块，扩展账户的执行能力。

**主要功能**:
- 安装/卸载执行器模块
- 管理执行器权限
- 支持批量执行
- 支持不同的调用类型（CALL, DELEGATECALL, STATICCALL）

#### 3.2.3 HookManager.sol - 钩子管理器

**功能**: 管理账户的钩子模块，在特定操作前后执行自定义逻辑。

**主要功能**:
- 安装/卸载钩子模块
- 在验证前/后执行钩子
- 在执行前/后执行钩子
- 支持 EntryPoint 级别的钩子

#### 3.2.4 SelectorManager.sol - 选择器管理器

**功能**: 管理函数选择器与验证器的映射关系。

**主要功能**:
- 设置特定函数选择器的验证器
- 支持函数级别的权限控制
- 管理选择器白名单/黑名单

---

### 3.3 工厂合约 (factory/)

#### 3.3.1 KernelFactory.sol - Kernel 工厂

**功能**: 使用 CREATE2 确定性地址创建 Kernel 账户实例。

**主要方法**:
```solidity
// 创建账户
function createAccount(bytes calldata data, bytes32 salt)
    public
    payable
    returns (address)

// 预测账户地址
function getAddress(bytes calldata data, bytes32 salt)
    public
    view
    virtual
    returns (address)
```

**特性**:
- 使用 ERC-1967 代理模式
- 支持确定性地址生成
- 支持账户初始化

#### 3.3.2 FactoryStaker.sol - 工厂质押合约

**功能**: 管理工厂合约在 EntryPoint 上的质押。

**主要功能**:
- 为工厂合约管理 EntryPoint 质押
- 支持工厂白名单
- 管理质押金额和锁定时间

---

### 3.4 验证器模块 (validator/)

#### 3.4.1 ECDSAValidator.sol - ECDSA 验证器

**功能**: 使用 ECDSA 签名验证用户操作。

**主要特性**:
- 支持单个所有者地址
- 实现 IValidator 和 IHook 接口
- 支持 ERC-1271 签名验证
- 支持 UserOperation 验证

**关键方法**:
```solidity
// 验证用户操作
function validateUserOp(PackedUserOperation calldata userOp, bytes32 userOpHash)
    external
    view
    returns (uint256 validationData)

// 验证签名
function isValidSignature(bytes32 hash, bytes calldata signature)
    external
    view
    returns (bytes4 magicValue)
```

#### 3.4.2 MultiChainValidator.sol - ECDSA 验证器（支持 Merkle Proof）

**功能**: ECDSA 签名验证器，支持 Merkle Proof 验证机制（可用于跨链验证场景）。

**重要说明**:
- **命名说明**: 合约名称中的 "MultiChain" 指的是支持 Merkle Proof 验证机制，可以用于跨链验证场景，但**不是指单个合约实例可以管理多链状态**。
- **部署方式**: 需要在每个目标链上独立部署此合约，每个部署实例只存储当前链的 owner 地址。
- **多链支持**: 实际的多链支持通过以下方式实现：
  1. 每个链上独立部署 MultiChainValidator 实例
  2. 使用 Merkle Proof 机制可以验证来自其他链的签名（需要外部服务生成 Merkle Tree）
  3. 每个链上的账户状态是独立的，不共享

**存储结构**:
- `ecdsaValidatorStorage`: 存储每个智能账户的 owner 地址（单链存储）
- 每个链上的 MultiChainValidator 实例管理该链上的账户验证

**验证方式**:
- **标准 ECDSA 验证** (65 bytes 签名): 直接验证 owner 签名
- **Merkle Proof 验证** (>65 bytes 签名): 支持 Merkle Proof，可用于跨链验证场景

#### 3.4.3 WeightedECDSAValidator.sol - 加权 ECDSA 验证器

**功能**: 支持多个签名者，每个签名者有不同的权重，需要达到阈值才能通过验证。

#### 3.4.4 EmitIdentifierValidator.sol - 事件标识符验证器

**功能**: 通过事件标识符进行验证的特殊验证器。

---

### 3.5 接口定义 (interfaces/)

#### 3.5.1 IAccount.sol
定义账户验证接口，包括 `validateUserOp` 方法。

#### 3.5.2 IAccountExecute.sol
定义账户执行接口，包括 `execute` 和 `executeBatch` 方法。

#### 3.5.3 IEntryPoint.sol
定义 ERC-4337 EntryPoint 接口，用于处理 UserOperation。

#### 3.5.4 IERC7579Account.sol
定义 ERC-7579 模块化账户接口，包括模块安装/卸载方法。

#### 3.5.5 IERC7579Modules.sol
定义 ERC-7579 模块接口，包括：
- `IValidator`: 验证器接口
- `IExecutor`: 执行器接口
- `IHook`: 钩子接口
- `IPolicy`: 策略接口
- `ISigner`: 签名器接口
- `IFallback`: 回退接口

#### 3.5.6 PackedUserOperation.sol
定义打包的用户操作结构，优化 Gas 使用。

---

### 3.6 工具库 (utils/)

#### 3.6.1 ExecLib.sol
提供执行相关的工具函数，包括批量执行、调用类型处理等。

#### 3.6.2 ModuleLib.sol
提供模块管理相关的工具函数，包括模块类型检查、模块安装验证等。

#### 3.6.3 ValidationTypeLib.sol
提供验证类型相关的工具函数，包括验证 ID 处理、验证模式管理等。

#### 3.6.4 KernelValidationResult.sol
提供验证结果处理相关的工具函数，包括验证数据合并等。

---

## 4. 配置方案

### 4.1 Hardhat 配置 (hardhat.config.ts)

```typescript
{
  solidity: {
    version: "0.8.25",
    settings: {
      viaIR: true,           // 启用 IR 优化
      optimizer: {
        enabled: true,
        runs: 1000,          // 优化运行次数
      },
    },
  },
  spdxLicenseIdentifier: {
    overwrite: false,
    runOnCompile: true
  },
  contractSizer: {
    alphaSort: true,
    runOnCompile: true,
    strict: true,
  }
}
```

**配置说明**:
- **viaIR**: 启用中间表示（IR）优化，可以进一步优化 Gas 使用
- **optimizer**: 启用优化器，运行次数设置为 1000，平衡 Gas 使用和部署成本
- **contractSizer**: 自动分析合约大小，帮助优化代码

### 4.2 Foundry 配置 (foundry.toml)

```toml
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
bytecode_hash = "none"
cbor_metadata = false
via-ir = false
optimizer = true
optimizer_runs = 200
evm_version = "prague"

[profile.deploy]
via-ir = true
```

**配置说明**:
- **默认配置**: 使用标准优化，运行次数 200
- **部署配置**: 启用 IR 优化，用于生产部署
- **EVM 版本**: 使用 Prague 版本

### 4.3 重映射配置 (remappings.txt)

```
ExcessivelySafeCall/=lib/ExcessivelySafeCall/src/
forge-std/=lib/forge-std/src/
solady/=lib/solady/src/
solady_test/=lib/solady/test/
```

**说明**: 配置了外部库的路径映射，包括：
- **ExcessivelySafeCall**: 安全调用库
- **forge-std**: Foundry 标准库
- **solady**: Solady 工具库

---

## 5. 部署方案

### 5.1 部署脚本结构

#### 5.1.1 Deploy.s.sol - 主部署脚本

**部署顺序**:
1. 部署 FactoryStaker（如果未部署）
2. 部署 Kernel 实现合约（如果未部署）
3. 部署 KernelFactory（如果未部署）
4. 配置 FactoryStaker 批准工厂
5. 配置 EntryPoint 质押

**关键地址**:
- `ENTRYPOINT_0_7_ADDR`: 0x0000000071727De22E5E9d8BAf0edAc6f37da032
- `CREATE2_PROXY`: 0x4e59b44847b379578588920cA78FbF26c0B4956C
- `EXPECTED_STAKER`: 0xd703aaE79538628d27099B8c4f621bE4CCd142d5
- `EXPECTED_KERNEL`: 0x94F097E1ebEB4ecA3AAE54cabb08905B239A7D27
- `EXPECTED_FACTORY`: 0x6723b44Abeec4E71eBE3232BD5B455805baDD22f

#### 5.1.2 DeployKernel.s.sol - Kernel 部署脚本

专门用于部署 Kernel 和 KernelFactory 的简化脚本。

#### 5.1.3 DeployECDSA.s.sol - ECDSA 验证器部署脚本

用于部署 ECDSAValidator 验证器合约。

### 5.2 部署网络配置

**Mantle 主网**:
- RPC URL: https://rpc.mantle.xyz
- Chain ID: 5000
- Explorer: https://mantlescan.xyz/

**Mantle Sepolia 测试网**:
- RPC URL: https://rpc.sepolia.mantle.xyz
- Chain ID: 5003
- Explorer: https://sepolia.mantlescan.xyz/

### 5.3 部署命令

**使用 Foundry 部署**:
```bash
forge script scripts/Deploy.s.sol:Deploy \
  --rpc-url mantle_sepolia \
  --broadcast \
  --verify \
  -vvvv
```

**使用 Hardhat 部署**:
```bash
npx hardhat run scripts/deploy.ts --network mantle_sepolia
```

---

## 6. 模块化架构

### 6.1 模块类型

系统支持以下模块类型：

1. **Validator (验证器)**: 验证用户操作和签名
2. **Executor (执行器)**: 扩展账户的执行能力
3. **Hook (钩子)**: 在特定操作前后执行自定义逻辑
4. **Policy (策略)**: 定义执行策略和规则
5. **Signer (签名器)**: 管理签名逻辑
6. **Fallback (回退)**: 处理未匹配的函数调用

### 6.2 模块安装流程

1. 用户调用 `installModule` 方法
2. 系统验证模块类型和接口
3. 调用模块的 `onInstall` 方法
4. 更新模块存储
5. 发出模块安装事件

### 6.3 模块卸载流程

1. 用户调用 `uninstallModule` 方法
2. 系统验证模块已安装
3. 调用模块的 `onUninstall` 方法
4. 清理模块存储
5. 发出模块卸载事件

---

## 7. 安全机制

### 7.1 验证机制

- **多重验证**: 支持 Root Validator、Validator 和 Permission 三层验证
- **签名验证**: 使用 ECDSA 或其他自定义验证算法
- **Nonce 管理**: 防止重放攻击
- **时间窗口**: 支持 ValidAfter 和 ValidUntil 时间限制

### 7.2 权限控制

- **函数级权限**: 通过 SelectorManager 控制特定函数的访问
- **权限标志**: 使用 PassFlag 控制权限行为
- **策略验证**: 通过 Policy 模块实现复杂权限逻辑

### 7.3 钩子机制

- **验证钩子**: 在验证前后执行自定义逻辑
- **执行钩子**: 在执行前后执行自定义逻辑
- **EntryPoint 钩子**: 在 EntryPoint 级别执行钩子

---

## 8. Gas 优化策略

### 8.1 代码优化

- 使用 `viaIR` 中间表示优化
- 优化器运行次数设置为 1000
- 使用打包的 UserOperation 结构

### 8.2 存储优化

- 使用紧凑的数据结构
- 使用存储槽打包
- 使用库函数减少代码重复

### 8.3 执行优化

- 支持批量执行
- 使用委托调用减少 Gas 消耗
- 优化验证逻辑

---

## 9. 与前端集成

### 9.1 ABI 定义

前端项目使用本地定义的 ABI（`src/utils/kernel-types.ts`），不直接依赖智能合约目录。

### 9.2 合约地址配置

前端需要配置以下合约地址：
- Kernel 实现地址
- KernelFactory 地址
- EntryPoint 地址
- 验证器地址（如 ECDSAValidator）

### 9.3 类型生成

可以使用 TypeChain 生成 TypeScript 类型：
```bash
npx typechain --target ethers-v6 --out-dir types './artifacts/**/*.json'
```

---

## 10. 开发工作流

### 10.1 编译合约

```bash
cd smart-services
npm install
npm run compile
```

### 10.2 运行测试

```bash
# 使用 Hardhat
npx hardhat test

# 使用 Foundry
forge test
```

### 10.3 代码检查

```bash
# 合约大小分析
npx hardhat size-contracts

# Gas 报告
REPORT_GAS=true npx hardhat test
```

---

## 11. 总结

### 11.1 架构特点

1. **模块化设计**: 支持灵活的模块安装和卸载
2. **标准兼容**: 完全兼容 ERC-4337 和 ERC-7579 标准
3. **可扩展性**: 通过模块系统轻松扩展功能
4. **安全性**: 多层验证和权限控制机制
5. **Gas 优化**: 多种优化策略降低 Gas 消耗

### 11.2 主要优势

- **用户友好**: 支持账户抽象，改善用户体验
- **灵活配置**: 支持多种验证和执行模式
- **跨链支持**: 通过多链验证器支持跨链场景
- **社区标准**: 遵循行业标准，易于集成

### 11.3 未来扩展方向

- 支持更多验证器类型（如多签、社交恢复等）
- 支持更多执行器类型（如批量操作、定时任务等）
- 优化 Gas 使用
- 增强安全机制
- 支持更多链和网络

---

## 附录

### A. 关键常量定义

参考 `contracts/src/types/Constants.sol` 文件，包含：
- 模块类型常量
- 验证类型常量
- 调用类型常量
- 执行类型常量
- 魔法值常量

### B. 数据结构定义

参考 `contracts/src/types/Structs.sol` 文件，包含：
- 模块安装数据结构
- 权限配置数据结构
- 选择器配置数据结构

### C. 相关文档

- [多链支持综合分析.md](./多链支持综合分析.md) - **多链支持技术设计文档**
- [智能合约账户创建流程.md](./智能合约账户创建流程.md) - **账户创建流程详解**
- [多链部署地址记录.md](./多链部署地址记录.md) - 多链部署地址记录
- [部署指南.md](./部署指南.md) - 部署指南
- [README.md](../README.md) - 项目说明
- [ERC-4337 规范](https://eips.ethereum.org/EIPS/eip-4337)
- [ERC-7579 规范](https://eips.ethereum.org/EIPS/eip-7579)

---

**文档结束**
