#!/bin/bash

# MultiChainValidator å¤šé“¾éƒ¨ç½²è„šæœ¬
# æ­¤è„šæœ¬ç”¨äºéƒ¨ç½² MultiChainValidator åˆ°å¤šä¸ªé“¾

set -e

echo "=========================================="
echo "å¤šé“¾éªŒè¯å™¨éƒ¨ç½²è„šæœ¬"
echo "=========================================="
echo ""

# ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if [ -f ".env" ]; then
    echo "ğŸ“„ ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡..."
    # ä½¿ç”¨ set -a è‡ªåŠ¨å¯¼å‡ºæ‰€æœ‰å˜é‡
    set -a
    source .env
    set +a
    echo "âœ… ç¯å¢ƒå˜é‡åŠ è½½å®Œæˆ"
    echo ""
fi

# æ£€æŸ¥ç¯å¢ƒå˜é‡
if [ -z "$PRIVATE_KEY" ]; then
    echo "âŒ é”™è¯¯: ç§é’¥ç¯å¢ƒå˜é‡æœªè®¾ç½®"
    echo "è¯·è®¾ç½®: export PRIVATE_KEY=your_private_key_here"
    echo "æˆ–è€…åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®: PRIVATE_KEY=your_private_key_here"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
if [ ! -f "foundry.toml" ]; then
    echo "âŒ é”™è¯¯: è¯·åœ¨ smart-services ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# ç¼–è¯‘åˆçº¦
echo "=== æ­¥éª¤ 1: ç¼–è¯‘åˆçº¦ ==="
forge build --via-ir
echo "âœ… åˆçº¦ç¼–è¯‘å®Œæˆ"
echo ""

# éƒ¨ç½²å‡½æ•°
deploy_to_chain() {
    local chain_name=$1
    local rpc_alias=$2
    local chain_id=$3
    
    echo "=========================================="
    echo "éƒ¨ç½²åˆ°: $chain_name (é“¾ ID: $chain_id)"
    echo "=========================================="
    
    # é»˜è®¤è‡ªåŠ¨ç¡®è®¤éƒ¨ç½²ï¼ˆ5ç§’å†…è¾“å…¥ n å¯å–æ¶ˆï¼‰
    echo "5ç§’åè‡ªåŠ¨å¼€å§‹éƒ¨ç½²ï¼Œè¾“å…¥ n å¯å–æ¶ˆ..."
    read -t 5 -p "æ˜¯å¦éƒ¨ç½²åˆ° $chain_name? (æ˜¯/å¦ï¼Œé»˜è®¤æ˜¯): " confirm || confirm=""
    if [ "$confirm" = "n" ] || [ "$confirm" = "N" ] || [ "$confirm" = "å¦" ]; then
        echo "â­ï¸  è·³è¿‡ $chain_name"
        echo ""
        return
    fi
    
    echo "æ­£åœ¨éƒ¨ç½²..."
    
    # æ„å»ºéƒ¨ç½²å‘½ä»¤
    local deploy_cmd="forge script scripts/DeployMultiChainValidator.s.sol:DeployMultiChainValidator \
        --rpc-url $rpc_alias \
        --broadcast \
        --private-key $PRIVATE_KEY \
        --via-ir \
        -vvvv"
    
    # å¦‚æœè®¾ç½®äº† ETHERSCAN_API_KEYï¼Œåˆ™æ·»åŠ éªŒè¯é€‰é¡¹
    if [ -n "$ETHERSCAN_API_KEY" ]; then
        echo "ğŸ“ å°†è¿›è¡Œåˆçº¦éªŒè¯..."
        deploy_cmd="$deploy_cmd --verify"
    else
        echo "âš ï¸  æœªè®¾ç½® ETHERSCAN_API_KEYï¼Œè·³è¿‡åˆçº¦éªŒè¯"
    fi
    
    # æ‰§è¡Œéƒ¨ç½²
    eval $deploy_cmd
    
    echo ""
    echo "âœ… $chain_name éƒ¨ç½²å®Œæˆ"
    echo "è¯·è®°å½•éƒ¨ç½²åœ°å€ï¼Œç¨åéœ€è¦æ›´æ–°é…ç½®æ–‡ä»¶"
    echo ""
}

# éƒ¨ç½²åˆ°å„ä¸ªé“¾
echo "=== æ­¥éª¤ 2: å¼€å§‹éƒ¨ç½² ==="
echo ""

# 1. Mantle Sepolia æµ‹è¯•ç½‘ (æ¨èå…ˆéƒ¨ç½²æµ‹è¯•ç½‘)
deploy_to_chain "Mantle Sepolia æµ‹è¯•ç½‘" "mantle_sepolia" "5003"

# 2. Mantle ä¸»ç½‘
deploy_to_chain "Mantle ä¸»ç½‘" "mantle_mainnet" "5000"

# 3. Injective æµ‹è¯•ç½‘
deploy_to_chain "Injective æµ‹è¯•ç½‘" "injective_testnet" "1439"

# 4. Injective ä¸»ç½‘
deploy_to_chain "Injective ä¸»ç½‘" "injective_mainnet" "1776"

echo "=========================================="
echo "éƒ¨ç½²å®Œæˆï¼"
echo "=========================================="
echo ""
echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
echo "1. è®°å½•æ¯ä¸ªé“¾çš„å¤šé“¾éªŒè¯å™¨éƒ¨ç½²åœ°å€"
echo "2. æ›´æ–° env.local æ–‡ä»¶ä¸­çš„åœ°å€é…ç½®"
echo "3. æ›´æ–° docs/å¤šé“¾éƒ¨ç½²åœ°å€è®°å½•.md"
echo "4. é‡å¯å¼€å‘æœåŠ¡å™¨ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰"
echo ""
